<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flutter IM åº”ç”¨æµç¨‹å›¾</title>
    <script type="module">
      (async () => {
        async function loadScript(src) {
          return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
          });
        }
        async function loadMermaid() {
          try {
            const mod = await import('vendor/mermaid.esm.min.mjs');
            const mer = mod.default || mod.mermaid || mod;
            if (mer) return mer;
          } catch (_) {}
          try {
            await loadScript('vendor/mermaid.min.js');
            if (window.mermaid) return window.mermaid;
          } catch (_) {}
          const urls = [
            'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs',
            'https://unpkg.com/mermaid@10/dist/mermaid.esm.min.mjs',
            'https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.9.1/mermaid.esm.min.mjs'
          ];
          for (const url of urls) {
            try {
              const mod = await import(url);
              const mer = mod.default || mod.mermaid || mod;
              if (mer) return mer;
            } catch (_) {}
          }
          await loadScript('https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js');
          return window.mermaid;
        }
        const mer = await loadMermaid();
        if (mer) window.mermaid = mer;
        document.dispatchEvent(new Event('mermaid-ready'));
      })();
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --accent-blue: #58a6ff;
            --accent-green: #3fb950;
            --accent-purple: #a371f7;
            --accent-orange: #d29922;
            --accent-pink: #f778ba;
            --accent-cyan: #39c5cf;
            --border-color: #30363d;
            --shadow: 0 8px 24px rgba(0,0,0,0.4);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans SC', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 60px;
            padding: 40px;
            background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%);
            border-radius: 20px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow);
        }
        
        h1 {
            font-size: 2.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple), var(--accent-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }
        
        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .nav-tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 40px;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            position: sticky;
            top: 20px;
            z-index: 100;
            backdrop-filter: blur(10px);
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        .nav-tab:hover {
            background: var(--bg-primary);
            border-color: var(--accent-blue);
            color: var(--accent-blue);
            transform: translateY(-2px);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            border-color: transparent;
            color: white;
            box-shadow: 0 4px 15px rgba(88, 166, 255, 0.3);
        }
        
        .section {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .icon-blue { background: linear-gradient(135deg, #1a3a5c, #2d5a87); }
        .icon-green { background: linear-gradient(135deg, #1a4a3a, #2d7a5a); }
        .icon-purple { background: linear-gradient(135deg, #3a2a5c, #5a4a87); }
        .icon-orange { background: linear-gradient(135deg, #5c4a1a, #876a2d); }
        .icon-pink { background: linear-gradient(135deg, #5c2a4a, #874a6a); }
        .icon-cyan { background: linear-gradient(135deg, #1a4a5c, #2d7a8a); }
        
        .card h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .card h3 {
            font-size: 1.2rem;
            font-weight: 500;
            color: var(--accent-blue);
            margin: 24px 0 16px;
        }
        
        .mermaid {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            overflow-x: auto;
            margin: 20px 0;
        }
        
        .mermaid-large-wrapper {
            position: relative;
            margin: 20px 0;
        }
        
        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
            display: flex;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }
        
        .zoom-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .zoom-btn:hover {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
        }
        
        .zoom-level {
            color: var(--text-secondary);
            font-size: 12px;
            display: flex;
            align-items: center;
            min-width: 45px;
            justify-content: center;
        }
        
        .mermaid-large {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 30px;
            overflow: auto;
            min-height: 500px;
            max-height: 800px;
            transform-origin: top left;
            transition: transform 0.2s ease;
        }
        
        .mermaid-large svg {
            min-width: 1000px;
            display: block;
        }
        
        .architecture-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }
        
        .arch-item {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .arch-item:hover {
            border-color: var(--accent-blue);
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(88, 166, 255, 0.15);
        }
        
        .arch-item h4 {
            color: var(--accent-cyan);
            font-size: 1rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .arch-item p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .file-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .file-table th,
        .file-table td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        .file-table th {
            background: var(--bg-tertiary);
            color: var(--accent-blue);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .file-table td {
            font-size: 0.95rem;
        }
        
        .file-table tr:hover td {
            background: var(--bg-tertiary);
        }
        
        .file-path {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-green);
            font-size: 0.85rem;
        }
        
        .flow-description {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid var(--accent-blue);
        }
        
        .flow-description h4 {
            color: var(--accent-blue);
            margin-bottom: 12px;
        }
        
        .flow-description ul {
            list-style: none;
            padding: 0;
        }
        
        .flow-description li {
            padding: 8px 0;
            padding-left: 24px;
            position: relative;
            color: var(--text-secondary);
        }
        
        .flow-description li::before {
            content: 'â†’';
            position: absolute;
            left: 0;
            color: var(--accent-green);
        }
        
        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent-purple);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 8px;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 2rem;
            }
            
            .nav-tabs {
                position: static;
            }
            
            .nav-tab {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
            
            .card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Flutter IM åº”ç”¨æµç¨‹å›¾</h1>
            <p>å®Œæ•´çš„åº”ç”¨æ¶æ„ä¸æ•°æ®æµè½¬å¯è§†åŒ–æ–‡æ¡£ï¼Œä»å¯åŠ¨åˆ°ä¼šè¯åˆ—è¡¨ã€èŠå¤©é¡µçš„å…¨æµç¨‹è§£æ</p>
        </header>
        
        <nav class="nav-tabs">
            <div class="nav-tab active" data-section="overview" onclick="showSection(event, 'overview')">ğŸ“± æ¶æ„æ¦‚è§ˆ</div>
            <div class="nav-tab" data-section="startup" onclick="showSection(event, 'startup')">ğŸš€ å¯åŠ¨æµç¨‹</div>
            <div class="nav-tab" data-section="upgrade" onclick="showSection(event, 'upgrade')">â¬†ï¸ ç‰ˆæœ¬å‡çº§</div>
            <div class="nav-tab" data-section="conversation" onclick="showSection(event, 'conversation')">ğŸ“‹ ä¼šè¯åˆ—è¡¨</div>
            <div class="nav-tab" data-section="chat" onclick="showSection(event, 'chat')">ğŸ’¬ èŠå¤©é¡µ</div>
            <div class="nav-tab" data-section="message" onclick="showSection(event, 'message')">ğŸ“¤ æ¶ˆæ¯æ”¶å‘</div>
            <div class="nav-tab" data-section="contact" onclick="showSection(event, 'contact')">ğŸ‘¥ è”ç³»äºº</div>
            <div class="nav-tab" data-section="mine" onclick="showSection(event, 'mine')">ğŸ‘¤ æˆ‘çš„</div>
            <div class="nav-tab" data-section="connection" onclick="showSection(event, 'connection')">ğŸ”Œ è¿æ¥ç®¡ç†</div>
            <div class="nav-tab" data-section="files" onclick="showSection(event, 'files')">ğŸ“ æ–‡ä»¶ç´¢å¼•</div>
        </nav>
        
        <!-- æ¶æ„æ¦‚è§ˆ -->
        <section id="overview" class="section active">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ“±</div>
                    <h2>åº”ç”¨æ•´ä½“æ¶æ„</h2>
                </div>
                
                <div class="mermaid">
graph TB
    subgraph UI["è¡¨ç°å±‚UI"]
        MainPage["MainPageä¸»é¡µè·¯ç”±"]
        MainTabPage["MainTabPageåº•éƒ¨Tabé¡µ"]
        ConvPage["HomeConversationPageä¼šè¯"]
        ContactPageUI["HomeContactPageè”ç³»äºº"]
        MyPageUI["MyPageæˆ‘çš„"]
        ChatPageUI["ChatPageèŠå¤©é¡µ"]
    end
    
    subgraph Logic["ä¸šåŠ¡é€»è¾‘å±‚"]
        ConvLogic["ConversationLogic"]
        ContactLogicL["ContactLogic"]
        MyInfoLogicL["MyInfoLogic"]
        ChatLogicL["ChatLogic"]
        Controllers["GetX Controllers"]
    end
    
    subgraph Data["æ•°æ®å±‚"]
        WKIM["WKIM SDK"]
        HTTP["HTTP API"]
        SQLite["æœ¬åœ°æ•°æ®åº“SQLite"]
    end
    
    subgraph Cache["ç¼“å­˜å±‚"]
        SP["SharedPreferences"]
        CacheHelper["CacheHelper"]
    end
    
    subgraph Comm["é€šä¿¡å±‚"]
        EventBus["EventBus"]
        Bloc["NaviCountBloc"]
    end
    
    MainPage --> MainTabPage
    MainTabPage --> ConvPage
    MainTabPage --> ContactPageUI
    MainTabPage --> MyPageUI
    ConvPage --> ChatPageUI
    
    ConvPage --> ConvLogic
    ContactPageUI --> ContactLogicL
    MyPageUI --> MyInfoLogicL
    ChatPageUI --> ChatLogicL
    
    ConvLogic --> WKIM
    ContactLogicL --> WKIM
    ChatLogicL --> WKIM
    ConvLogic --> HTTP
    ChatLogicL --> HTTP
    MyInfoLogicL --> HTTP
    
    WKIM --> SQLite
    HTTP --> CacheHelper
    CacheHelper --> SP
    
    ConvLogic --> EventBus
    ChatLogicL --> EventBus
    ContactLogicL --> EventBus
    EventBus --> Bloc
                </div>
                
                <div class="architecture-grid">
                    <div class="arch-item">
                        <h4>ğŸ¨ è¡¨ç°å±‚ (UI)</h4>
                        <p>MainPage â†’ MainTabPage â†’ HomeConversationPage / HomeContactPage / MyPage / ChatPageï¼Œè´Ÿè´£ç•Œé¢å±•ç¤ºå’Œç”¨æˆ·äº¤äº’</p>
                    </div>
                    <div class="arch-item">
                        <h4>âš™ï¸ ä¸šåŠ¡é€»è¾‘å±‚</h4>
                        <p>GetX Controllers (HomeConversationLogic, ContactLogic, MyInfoLogic, ChatLogic)ï¼Œå¤„ç†ä¸šåŠ¡é€»è¾‘å’ŒçŠ¶æ€ç®¡ç†</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ’¾ æ•°æ®å±‚</h4>
                        <p>WKIM SDK (æ‚Ÿç©ºIM) + HTTP APIï¼Œè´Ÿè´£æ•°æ®è·å–å’ŒæŒä¹…åŒ–</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ—„ï¸ ç¼“å­˜å±‚</h4>
                        <p>Cache (SharedPreferences) + CacheHelperï¼Œæœ¬åœ°æ•°æ®ç¼“å­˜</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ“¡ é€šä¿¡å±‚</h4>
                        <p>EventBus + Bloc (NaviCountBloc)ï¼Œç»„ä»¶é—´é€šä¿¡å’ŒçŠ¶æ€åŒæ­¥</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ”„</div>
                    <h2>æ ¸å¿ƒæ•°æ®æµ</h2>
                </div>
                
                <div class="mermaid">
flowchart LR
    Server["æœåŠ¡å™¨IM+API"]
    SDK["WKIM SDKé•¿è¿æ¥"]
    DB["æœ¬åœ°æ•°æ®åº“SQLite"]
    
    subgraph Listeners["ç›‘å¬å™¨å±‚"]
        L1["OnNewMsgListener"]
        L2["OnRefreshMsgListListener"]
        L3["OnConnectionStatusListener"]
    end
    
    subgraph ControllersLayer["Controllerå±‚"]
        C1["ChatLogic"]
        C2["ConversationLogic"]
        C3["HomeConversationLogic"]
    end
    
    subgraph Views["UIå±‚"]
        V1["ChatPage"]
        V2["ConversationListPage"]
        V3["HomeConversationPage"]
    end
    
    Server <--> SDK
    SDK <--> DB
    SDK --> Listeners
    
    L1 --> C1
    L2 --> C2
    L3 --> C3
    
    C1 --> V1
    C2 --> V2
    C3 --> V3
                </div>
            </div>
        </section>
        
        <!-- å¯åŠ¨æµç¨‹ -->
        <section id="startup" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green">ğŸš€</div>
                    <h2>åº”ç”¨å¯åŠ¨æµç¨‹ - main()</h2>
                </div>
                
                <div class="mermaid">
%%{init: {'flowchart': {'nodeSpacing': 25, 'rankSpacing': 35, 'curve': 'basis'}}}%%
flowchart TD
    Start(["mainå‡½æ•°å…¥å£"]) --> A["1. WidgetsFlutterBinding.ensureInitialized"] --> B["2. FlutterNativeSplash.preserve"] --> C["3. GlobalErrorHandler.init"] --> D["4. await initApp()"]
    
    subgraph InitApp["initAppè¯¦ç»†æµç¨‹"]
        D1["await Cache.instance.init()"]
        D2["await CommonHelper.init()"]
        D3["await FileUtils.init()"]
        D4["await NotificationUtils.init()"]
        D5["BackgroundTask.init()"]
        D6["NetworkManager.startListening()"]
        D7["ç¿»è¯‘/åˆ†äº«/å†…å­˜ç®¡ç†ç­‰åˆå§‹åŒ–, awaitåŸç”Ÿå±‚æ—¥å¿—é€šé“åˆå§‹åŒ–"]
        
        D1 --> D2 --> D3 --> D4 --> D5 --> D6 --> D7
    end
    
    D --> D1
    
    subgraph CommonInit["CommonHelper.initè¯¦ç»†"]
        E1{"isLogin?"} -->|æ˜¯| E2["await IMUtils.initIM()"]
        E1 -->|å¦| E3["å®Œæˆ"]
        E2 --> E3
    end
    
    D2 -.-> E1
    
    subgraph IMInit["IMUtils.initIMè¯¦ç»†"]
        F1["WKIM.shared.setup"] --> F2["é…ç½®getAddrå›è°ƒ"] --> F3["connect()"] --> F4["registerMsgContent()"] --> F5["addListener()"]
    end
    
    E2 -.-> F1
    
    D7 --> G["5. FlutterNativeSplash.remove"] --> H["6. runApp(App())"]
    
    subgraph PostRunApp["runAppåç»­æµç¨‹"]
        P1["setSystemUI() åŒæ­¥"]
        P2["await BackgroundTask.notifyFlutterReady()"]
        P3["await BackgroundTask.setPrivacyMode()"]
        
        P1 --> P2 --> P3
    end
    
    H --> P1
    P3 --> EndNode(["å¯åŠ¨å®Œæˆ"])
                </div>
                
                <div class="flow-description">
                    <h4>å¯åŠ¨æµç¨‹è¯´æ˜</h4>
                    <ul>
                        <li><span class="step-number">1</span><strong>åŸºç¡€åˆå§‹åŒ–:</strong> WidgetsFlutterBinding ç¡®ä¿ Flutter å¼•æ“åˆå§‹åŒ–å®Œæˆ</li>
                        <li><span class="step-number">2</span><strong>å¯åŠ¨å±ä¿æŒ:</strong> FlutterNativeSplash.preserve ä¿æŒåŸç”Ÿå¯åŠ¨å±æ˜¾ç¤º</li>
                        <li><span class="step-number">3</span><strong>é”™è¯¯å¤„ç†:</strong> GlobalErrorHandler åˆå§‹åŒ–å…¨å±€é”™è¯¯æ•è·</li>
                        <li><span class="step-number">4</span><strong>åº”ç”¨åˆå§‹åŒ–:</strong> initApp ä¸²è¡Œåˆå§‹åŒ–å„æ¨¡å—ï¼ˆCache â†’ CommonHelper â†’ FileUtils â†’ NotificationUtils ç­‰ï¼‰</li>
                        <li><span class="step-number">5</span><strong>ç§»é™¤å¯åŠ¨å±:</strong> åˆå§‹åŒ–å®Œæˆåç§»é™¤åŸç”Ÿå¯åŠ¨å±</li>
                        <li><span class="step-number">6</span><strong>è¿è¡Œåº”ç”¨:</strong> runApp å¯åŠ¨ Flutter åº”ç”¨</li>
                        <li><span class="step-number">7</span><strong>ç³»ç»ŸUIè®¾ç½®:</strong> setSystemUI() é…ç½®çŠ¶æ€æ æ ·å¼ã€å¯¼èˆªæ é¢œè‰²ã€å±å¹•æ–¹å‘ï¼ˆåŒæ­¥è°ƒç”¨ï¼‰</li>
                        <li><span class="step-number">8</span><strong>é€šçŸ¥åŸç”Ÿå±‚:</strong> await BackgroundTask.notifyFlutterReady() é€šçŸ¥åŸç”Ÿä»£ç Flutterå¼•æ“å·²å‡†å¤‡å¥½ï¼Œå¤„ç†å†·å¯åŠ¨æ—¶çš„æ¨é€é€šçŸ¥</li>
                        <li><span class="step-number">9</span><strong>åŒæ­¥éšç§æ¨¡å¼:</strong> await BackgroundTask.setPrivacyMode() åŒæ­¥éšç§æ¨¡å¼çŠ¶æ€åˆ°iOSç«¯</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-cyan">ğŸ </div>
                    <h2>é¦–é¡µè·¯ç”±åˆ¤æ–­æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
%%{init: {'flowchart': {'nodeSpacing': 20, 'rankSpacing': 30, 'curve': 'basis'}}}%%
flowchart TD
    Start(["MainPage.build"]) --> A{"CommonHelper.isLogin?"}
    A -->|å¦| B["return LoginPage"]
    A -->|æ˜¯| C{"hasPhone?"}
    C -->|å¦| D["return CompleteUserInfoPage"]
    C -->|æ˜¯| E["return Stack"] --> F["MainTabPage"] & G{"showOverlay?"}
    G -->|æ˜¯| H["buildOverlayView(æ ¹æ®éšç§æ¨¡å¼æ˜¾ç¤ºä¸åŒçš„å¯åŠ¨logo)"]
    G -->|å¦| I["ç›´æ¥æ˜¾ç¤º"]
    F --> J["Tab0: HomeConversationPage"] & K["Tab1: HomeContactPage"] & L["Tab2: MyPage"]
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ§©</div>
                    <h2>App Widget åˆå§‹åŒ–</h2>
                </div>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">ğŸ’¡ ä½¿ç”¨å³ä¸Šè§’æŒ‰é’®ç¼©æ”¾æŸ¥çœ‹ï¼Œæˆ–æ»šåŠ¨æŸ¥çœ‹å®Œæ•´æµç¨‹å›¾</p>
                
                <div class="mermaid-large-wrapper">
                    <div class="zoom-controls">
                        <button class="zoom-btn" onclick="zoomChart('app-widget-init-chart', -0.1)" title="ç¼©å°">âˆ’</button>
                        <span class="zoom-level" id="app-widget-init-chart-level">100%</span>
                        <button class="zoom-btn" onclick="zoomChart('app-widget-init-chart', 0.1)" title="æ”¾å¤§">+</button>
                        <button class="zoom-btn" onclick="resetZoom('app-widget-init-chart')" title="é‡ç½®">â†º</button>
                    </div>
                    <div class="mermaid-large" id="app-widget-init-chart">
%%{init: {'flowchart': {'nodeSpacing': 15, 'rankSpacing': 25, 'curve': 'basis'}}}%%
flowchart LR
    subgraph Init["ğŸš€ initState"]
        direction TB
        InitState["AppState.initState()"] --> Obs["addObserver"] & InitAppW["initApp()"] & DeepLinks["initDeepLinks()"] & RegDM["registerCallbacks()"] & AppDM["AppDownloadManager"] & Privacy["PrivacyModeManager"]
    end
    
    subgraph InitResult["ğŸ“¦ åˆå§‹åŒ–ç»“æœ"]
        direction TB
        Locale["è®¾ç½®å¤šè¯­è¨€"]
        DeepLinksOK["DeepLinkå°±ç»ª"]
        RegDMOK["ä¸‹è½½å›è°ƒæ³¨å†Œ"]
        AppDMOK["ä¸‹è½½ç®¡ç†å™¨å°±ç»ª"]
        PrivacyOK["éšç§æ¨¡å¼å°±ç»ª"]
    end
    
    InitAppW --> Locale
    DeepLinks --> DeepLinksOK
    RegDM --> RegDMOK
    AppDM --> AppDMOK
    Privacy --> PrivacyOK
    
    subgraph Lifecycle["ğŸ”„ ç”Ÿå‘½å‘¨æœŸ"]
        direction TB
        Life["didChangeAppLifecycleState"] --> Resumed["resumedå‰å°"] & Paused["pausedåå°"]
    end
    
    subgraph ForegroundOps["â˜€ï¸ å‰å°"]
        direction TB
        BG1["handleChange(true)"] --> StopHB["stopHeartbeat"] & CheckConn["æ£€æŸ¥è¿æ¥"]
    end
    
    subgraph BackgroundOps["ğŸŒ™ åå°"]
        direction TB
        BG2["handleChange(false)"] --> StartHB["startHeartbeat"] & Mem["evictCache()"]
    end
    
    Resumed --> ForegroundOps
    Paused --> BackgroundOps
    
    subgraph BuildWidget["ğŸ—ï¸ build"]
        direction TB
        Build["GetMaterialApp"] --> Bloc["MultiBlocProvider"] --> Navi["NaviCountBloc"]
        Build --> Home["MainPage()"]
    end
                    </div>
                </div>
            </div>
        </section>
        
        <!-- ç‰ˆæœ¬å‡çº§ -->
        <section id="upgrade" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-orange">â¬†ï¸</div>
                    <h2>ç‰ˆæœ¬å‡çº§æ£€æŸ¥æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph Trigger["è§¦å‘æ—¶æœº"]
        T1["åº”ç”¨å¯åŠ¨è¿›å…¥ä¸»é¡µ"]
        T2["è®¾ç½®é¡µæ‰‹åŠ¨æ£€æŸ¥"]
    end
    
    T1 --> Check["checkAppVersion"]
    T2 --> Check
    
    Check --> Channel{"åˆ¤æ–­æ¸ é“ç±»å‹"}
    Channel -->|GooglePlay| GP["checkVestVersion"]
    Channel -->|å…¶ä»–æ¸ é“| Other["checkAppVersion"]
    
    GP --> Compare["canUpdateç‰ˆæœ¬æ¯”è¾ƒ"]
    Other --> Compare
    
    Compare --> Result{"éœ€è¦æ›´æ–°?"}
    Result -->|å¦| NoUpdate["è¿”å›ä¸åšæ“ä½œ"]
    Result -->|æ˜¯| Force{"isForceå¼ºåˆ¶æ›´æ–°?"}
    
    Force -->|æ˜¯| ForcePage["AppUpgradePage.show"]
    Force -->|å¦| NonForce{"GooglePlayæ¸ é“?"}
    
    NonForce -->|æ˜¯| Silent["é™é»˜æ›´æ–°"]
    NonForce -->|å¦| CheckRemind{"å·²æé†’è¿‡ç›¸åŒç‰ˆæœ¬?"}
    
    CheckRemind -->|æ˜¯| Skip["è·³è¿‡"]
    CheckRemind -->|å¦| SaveVersion["ä¿å­˜æé†’æ—¶é—´å’Œç‰ˆæœ¬å·"]
    SaveVersion --> ShowDialog["AppUpgradeDialog"]
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green">ğŸ“¥</div>
                    <h2>ä¸‹è½½ä¸å®‰è£…æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["updateApp"])
    
    Start --> Platform{"å¹³å°åˆ¤æ–­"}
    Platform -->|iOS| AppStore["è·³è½¬AppStore"]
    Platform -->|Android| AndroidCheck["æ£€æŸ¥ä¸‹è½½æ¡ä»¶"]
    
    AndroidCheck --> Conditions["æ£€æŸ¥æƒé™å’ŒURL"]
    Conditions --> CanDownload{"canDownload?"}
    
    CanDownload -->|å¦| Browser["æ‰“å¼€å¤–éƒ¨æµè§ˆå™¨ä¸‹è½½"]
    CanDownload -->|æ˜¯| SilentCheck{"isSilenté™é»˜æ›´æ–°?"}
    
    SilentCheck -->|æ˜¯| WiFiCheck{"WiFiè¿æ¥?"}
    WiFiCheck -->|æ˜¯| Download["downloadApk"]
    WiFiCheck -->|å¦| Downloaded{"å·²ä¸‹è½½å®Œæˆ?"}
    Downloaded -->|æ˜¯| Apply["applyApkWithLoading"]
    Downloaded -->|å¦| Wait["æš‚ä¸ä¸‹è½½"]
    
    SilentCheck -->|å¦| Download
    
    subgraph DownloadProcess["ä¸‹è½½æµç¨‹"]
        DP1["æ£€æŸ¥æ˜¯å¦å·²ä¸‹è½½å®Œæˆ"]
        DP2{"å·²å®Œæˆ?"}
        DP3["æäº¤ä¸‹è½½ä»»åŠ¡"]
        DP4["progressStreamç›‘å¬è¿›åº¦"]
        DP5["æ›´æ–°downloadStatus"]
        DP6["ä¸‹è½½å®Œæˆ"]
    end
    
    Download --> DP1 --> DP2
    DP2 -->|æ˜¯| Apply
    DP2 -->|å¦| DP3 --> DP4 --> DP5 --> DP6 --> Apply
    
    subgraph InstallProcess["å®‰è£…æµç¨‹applyApk"]
        I1["æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åŠ å¯†"]
        I2{"åŠ å¯†?"}
        I3["decryptFileè§£å¯†"]
        I4{"æœ‰å®‰è£…æƒé™?"}
        I5["installApkç³»ç»Ÿå®‰è£…"]
        I6["patchApkçƒ­ä¿®å¤"]
        I7["æ˜¾ç¤ºé‡å¯ç¡®è®¤å¯¹è¯æ¡†"]
        I8["restartApp"]
        I9["æ¸…ç†ä¸´æ—¶æ–‡ä»¶"]
    end
    
    Apply --> I1 --> I2
    I2 -->|æ˜¯| I3 --> I4
    I2 -->|å¦| I4
    I4 -->|æ˜¯| I5 --> I9
    I4 -->|å¦| I6 --> I7 --> I8 --> I9
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ§¾</div>
                    <h2>æ›´æ–°å¯¹è¯æ¡† UI ç»„æˆ</h2>
                </div>
                <div class="flow-description">
                    <h4>AppUpgradeDialog</h4>
                    <ul>
                        <li>æ ‡é¢˜ï¼šå‘ç°æ–°ç‰ˆæœ¬</li>
                        <li>æ˜¾ç¤ºç‰ˆæœ¬å·ä¸æ›´æ–°è¯´æ˜</li>
                        <li>ç«‹å³å‡çº§æŒ‰é’®</li>
                        <li>è·³è¿‡æŒ‰é’®ï¼ˆä¸æ”¯æŒçƒ­ä¿®å¤æ—¶æ˜¾ç¤ºï¼‰</li>
                        <li>ä¸‹è½½è¿›åº¦æ¡ï¼ˆä¸‹è½½ä¸­æ˜¾ç¤ºï¼‰</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- ä¼šè¯åˆ—è¡¨ -->
        <section id="conversation" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ“‹</div>
                    <h2>ä¼šè¯åˆ—è¡¨æ•°æ®åŠ è½½æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph MainTab["MainTabPageåˆå§‹åŒ–"]
        M1["initState"]
        M2["åˆ›å»ºåº•éƒ¨Tabé…ç½®"]
        M3["AppLifecycleListeneræ³¨å†Œ"]
        M4["initialSync"]
        M5["AppUpgradeUtils.checkAppUpdateHome"]
        M6["NotificationUtils.requestNotificationPermission"]
        M7["DynamicIconManager.checkFakeAppIcon"]
    end
    
    M1 --> M2 --> M3 --> M4 --> M5 --> M6 --> M7
    
    subgraph InitialSync["initialSyncè¯¦ç»†"]
        S1["æ£€æŸ¥Tokenæœ‰æ•ˆæ€§"]
        S2{"CacheHelper.syncFriend?"}
        S3["syncFriendsåŒæ­¥å¥½å‹"]
        S4["syncFriendApplyCount"]
        S5["syncOnlineUsers"]
        S6["clearAllNotifications"]
    end
    
    M4 --> S1 --> S2
    S2 -->|æ˜¯| S3 --> S4
    S2 -->|å¦| S4
    S4 --> S5 --> S6
    
    S6 --> Conv["HomeConversationPage.initState"]
    
    subgraph ConvInit["HomeConversationPageåˆå§‹åŒ–"]
        C1["Get.put HomeConversationLogic"]
        C2["Get.put ChatFolderManager"]
        C3["ever logic.list"]
    end
    
    Conv --> C1 --> C2 --> C3
    
    C3 --> Logic["HomeConversationLogic.onReady"]
    
    subgraph LogicInit["Logicåˆå§‹åŒ–"]
        L1["super.onReady"]
        L2["initListener"]
    end
    
    Logic --> L1 --> L2
    
    L1 --> LoadData["ConversationLogic.loadData"]
    
    subgraph DataLoad["æ•°æ®åŠ è½½"]
        DL1["conversationManager.getAll"]
        DL2["ä»æœ¬åœ°æ•°æ®åº“è·å–ä¼šè¯"]
        DL3["sortMsgæ’åº"]
        DL4["return result"]
    end
    
    LoadData --> DL1 --> DL2 --> DL3 --> DL4
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ‘‚</div>
                    <h2>ConversationLogic ç›‘å¬å™¨</h2>
                </div>
                
                <h3>ç›‘å¬å™¨åˆ—è¡¨</h3>
                <div class="mermaid">
flowchart LR
    subgraph Listeners["initListener æ³¨å†Œçš„ 8 ä¸ªç›‘å¬å™¨"]
        L1["1. ClearAllRedDotListener - æ¸…é™¤æ‰€æœ‰æœªè¯»çº¢ç‚¹"]
        L2["2. RefreshMsgListListener - åˆ·æ–°ä¼šè¯åˆ—è¡¨"]
        L3["3. DeleteMsgListener - åˆ é™¤ä¼šè¯"]
        L4["4. RefreshListener - åˆ·æ–°é¢‘é“èµ„æ–™"]
        L5["5. ClearChannelMsgListener - æ¸…é™¤é¢‘é“æ¶ˆæ¯"]
        L6["6. RefreshMsgListener - æ¶ˆæ¯æ›´æ–°"]
        L7["7. NewReminderListener - æ–°æé†’(@æ¶ˆæ¯)"]
        L8["8. CmdListener - å‘½ä»¤ç›‘å¬"]
    end
                </div>
                
                <h3>1. ClearAllRedDotListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H1A["è§¦å‘: æ¸…é™¤æ‰€æœ‰æœªè¯»æ•°"] --> H1B["list.refresh()"] --> H1C["åˆ·æ–°UIæ˜¾ç¤º"]
                </div>
                
                <h3>2. RefreshMsgListListener å¤„ç†ï¼ˆæ ¸å¿ƒï¼‰</h3>
                <div class="mermaid">
flowchart LR
    H2A["è§¦å‘: æ”¶åˆ°æ–°æ¶ˆæ¯/æ¶ˆæ¯çŠ¶æ€å˜åŒ–"] --> H2B["æ„å»º msgMap å¿«é€ŸæŸ¥æ‰¾"] --> H2C{"ä¼šè¯æ˜¯å¦å­˜åœ¨?"}
    H2C -->|æ˜¯| H2D["æ›´æ–°ç°æœ‰ä¼šè¯å¹¶åˆ·æ–°ç¼“å­˜"] --> H2F["åˆå¹¶åˆ—è¡¨ totalList"]
    H2C -->|å¦| H2E["æ·»åŠ æ–°ä¼šè¯ isDeleted==0"] --> H2F
    H2F --> H2G["sortMsg é‡æ–°æ’åº"] --> H2H["è¿‡æ»¤ hide çŠ¶æ€"] --> H2I["æ›´æ–° list.value"]
                </div>
                
                <h3>3. DeleteMsgListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H3A["è§¦å‘: åˆ é™¤ä¼šè¯"] --> H3B["æŸ¥æ‰¾ä¼šè¯ç´¢å¼•"] --> H3C{"æ‰¾åˆ°ä¼šè¯?"}
    H3C -->|æ˜¯| H3D["list.removeAt index"] --> H3E["ç§»é™¤ç¼“å­˜"] --> H3F["å®Œæˆ"]
    H3C -->|å¦| H3F
                </div>
                
                <h3>4. RefreshListener (Channel) å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H4A["è§¦å‘: é¢‘é“èµ„æ–™æ›´æ–° top/muteç­‰"] --> H4B["æ›´æ–°ç¼“å­˜ç®¡ç†å™¨ä¸­çš„channel"] --> H4C["æŸ¥æ‰¾å¹¶æ›´æ–°ä¼šè¯çš„channel"] --> H4D["sortMsgSync åŒæ­¥æ’åº"] --> H4E["åˆ·æ–°éšè—ç½®é¡¶ä¼šè¯æ•°é‡"]
                </div>
                
                <h3>5. ClearChannelMsgListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H5A["è§¦å‘: æ¸…é™¤é¢‘é“èŠå¤©è®°å½•"] --> H5B["æŸ¥æ‰¾ä¼šè¯ç´¢å¼•"] --> H5C{"æ‰¾åˆ°ä¼šè¯?"}
    H5C -->|æ˜¯| H5D["list.removeAt index"] --> H5E["ç§»é™¤ç¼“å­˜"] --> H5F["updateAllUnread æ›´æ–°åº•éƒ¨Tabæœªè¯»æ•°"]
    H5C -->|å¦| H5F
                </div>
                
                <h3>6. RefreshMsgListener (Message) å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H6A["è§¦å‘: å•æ¡æ¶ˆæ¯æ›´æ–°"] --> H6B["getUIMsgWithChannel è·å–æœ€æ–°ä¼šè¯"] --> H6C{"ä¼šè¯å­˜åœ¨?"}
    H6C -->|æ˜¯| H6D["ç»§æ‰¿æ—§ä¼šè¯çš„channelç¼“å­˜"] --> H6E["æ›¿æ¢ä¼šè¯ list index = newConv"] --> H6F["åˆ·æ–°ç¼“å­˜"] --> H6G["sortMsgSync åŒæ­¥æ’åº"]
    H6C -->|å¦| H6G
                </div>
                
                <h3>7. NewReminderListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H7A["è§¦å‘: æ”¶åˆ°@æ¶ˆæ¯æé†’"] --> H7B{"ç¼“å­˜æ˜¯å¦å­˜åœ¨?"}
    H7B -->|æ˜¯| H7C["æ›´æ–°ç¼“å­˜ä¸­çš„æé†’æ•°æ®"] --> H7F["refreshData åˆ·æ–°åˆ—è¡¨"]
    H7B -->|å¦| H7D["æŸ¥æ‰¾å¯¹åº”ä¼šè¯"] --> H7E["refreshConversationCache åˆ›å»ºç¼“å­˜å¹¶åŠ è½½æ•°æ®"] --> H7F
                </div>
                
                <h3>8. CmdListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H8A["è§¦å‘: æ”¶åˆ°CMDå‘½ä»¤"] --> H8B{"cmdç±»å‹åˆ¤æ–­"}
    H8B -->|syncChannelUnread| H8C["åŒæ­¥é¢‘é“æœªè¯»æ•°"] --> H8D["refreshData åˆ·æ–°åˆ—è¡¨"] --> H8E["updateAllUnread æ›´æ–°åº•éƒ¨Tabæœªè¯»æ•°"]
                </div>
                
                <div class="flow-description">
                    <h4>ç›‘å¬å™¨è¯¦ç»†è¯´æ˜</h4>
                    <ul>
                        <li><span class="step-number">1</span><strong>ClearAllRedDotListener</strong> - å½“ç”¨æˆ·æ‰§è¡Œ"æ¸…é™¤æ‰€æœ‰æœªè¯»"æ“ä½œæ—¶è§¦å‘ï¼Œè°ƒç”¨ list.refresh() åˆ·æ–°æ•´ä¸ªåˆ—è¡¨UI</li>
                        <li><span class="step-number">2</span><strong>RefreshMsgListListener</strong> - æ ¸å¿ƒç›‘å¬å™¨ï¼Œæ”¶åˆ°æ–°æ¶ˆæ¯æˆ–æ¶ˆæ¯çŠ¶æ€å˜åŒ–æ—¶è§¦å‘ï¼Œè´Ÿè´£åˆå¹¶æ›´æ–°ä¼šè¯ã€æ·»åŠ æ–°ä¼šè¯ã€æ’åºå¹¶è¿‡æ»¤éšè—çŠ¶æ€</li>
                        <li><span class="step-number">3</span><strong>DeleteMsgListener</strong> - åˆ é™¤ä¼šè¯æ—¶è§¦å‘ï¼Œä»åˆ—è¡¨ä¸­ç§»é™¤å¯¹åº”ä¼šè¯å¹¶æ¸…é™¤ç¼“å­˜</li>
                        <li><span class="step-number">4</span><strong>RefreshListener (Channel)</strong> - é¢‘é“èµ„æ–™æ›´æ–°æ—¶è§¦å‘ï¼ˆå¦‚ç½®é¡¶ã€é™éŸ³çŠ¶æ€å˜åŒ–ï¼‰ï¼Œæ›´æ–°ç¼“å­˜å¹¶é‡æ–°æ’åº</li>
                        <li><span class="step-number">5</span><strong>ClearChannelMsgListener</strong> - æ¸…é™¤é¢‘é“èŠå¤©è®°å½•æ—¶è§¦å‘ï¼Œç§»é™¤ä¼šè¯ã€æ¸…é™¤ç¼“å­˜å¹¶æ›´æ–°åº•éƒ¨Tabæœªè¯»æ•°</li>
                        <li><span class="step-number">6</span><strong>RefreshMsgListener (Message)</strong> - å•æ¡æ¶ˆæ¯æ›´æ–°æ—¶è§¦å‘ï¼ˆå¦‚å‘é€çŠ¶æ€å˜åŒ–ï¼‰ï¼Œè·å–æœ€æ–°ä¼šè¯æ•°æ®å¹¶æ›¿æ¢</li>
                        <li><span class="step-number">7</span><strong>NewReminderListener</strong> - æ”¶åˆ°@æ¶ˆæ¯æé†’æ—¶è§¦å‘ï¼Œæ›´æ–°ç¼“å­˜ä¸­çš„æé†’æ•°æ®æˆ–åˆ›å»ºæ–°ç¼“å­˜</li>
                        <li><span class="step-number">8</span><strong>CmdListener</strong> - æ”¶åˆ°æœåŠ¡ç«¯CMDå‘½ä»¤æ—¶è§¦å‘ï¼Œç›®å‰å¤„ç† syncChannelUnread å‘½ä»¤æ¥åŒæ­¥æœªè¯»æ•°</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-cyan">ğŸ”„</div>
                    <h2>WKIM SDK ä¼šè¯åŒæ­¥æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant Server as Server
    participant SDK as WKIM_SDK
    participant DB as LocalDB
    participant Logic as ConvLogic
    participant UI as UILayer
    
    Note over Server,UI: IMè¿æ¥å»ºç«‹åè‡ªåŠ¨è§¦å‘
    
    SDK->>SDK: addOnSyncConversationListener
    SDK->>Server: syncConversation
    Server-->>SDK: è¿”å›ä¼šè¯åˆ—è¡¨æ•°æ®
    Note right of Server: ä¼šè¯ä¿¡æ¯/æ¶ˆæ¯/æœªè¯»æ•°
    
    SDK->>DB: ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    SDK->>Logic: OnRefreshMsgListListener
    Logic->>Logic: æ›´æ–°list.value
    Logic->>UI: Rxå“åº”å¼æ›´æ–°
    UI->>UI: é‡æ–°æ¸²æŸ“ä¼šè¯åˆ—è¡¨
    
    Note over Server,UI: æŒ‰é¢‘é“åŒæ­¥æ¶ˆæ¯
    
    SDK->>SDK: addOnSyncChannelMsgListener
    SDK->>Server: syncChannelMsg
    Server-->>SDK: è¿”å›é¢‘é“æ¶ˆæ¯
    SDK->>DB: ä¿å­˜æ¶ˆæ¯
                </div>
            </div>
        </section>
        
        <!-- èŠå¤©é¡µ -->
        <section id="chat" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-pink">ğŸ’¬</div>
                    <h2>è¿›å…¥èŠå¤©é¡µæµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart LR
    Start(["ç‚¹å‡»ä¼šè¯é¡¹"])
    
    Start --> Click["UiConversationItem.onTap"]
    Click --> Open["ChatPage.open"]
    Open --> Navigate["Get.to ChatPage"]
    
    Navigate --> Init["ChatPage.initState"]
    
    subgraph PageInit["ChatPageåˆå§‹åŒ–"]
        P1["initData"]
        P2["åˆ›å»ºmessageItemCallback"]
        P3["è®¾ç½®listViewControllerå›è°ƒ"]
        P4["è®¢é˜…GroupExitEvent"]
        P5["è®¢é˜…logic.draft"]
        P6["è®¢é˜…logic.replyWKMsg"]
        P7["è®¾ç½®currentChannelID"]
        P8["åˆå§‹åŒ–åŠ¨ç”»æ§åˆ¶å™¨"]
    end
    
    Init --> P1 --> P2 --> P3 --> P4 --> P5 --> P6 --> P7 --> P8
    
    P8 --> LogicReady["ChatLogic.onReady"]
    
    subgraph ChatLogicInit["ChatLogic.onReadyæµç¨‹"]
        CL1["1.initMessageListener"]
        CL2["2.initConnectionListener"]
        CL3["3.initChannel"]
        CL4["4.super.onReady"]
        CL5["5.initSync"]
        CL6["6.è®¢é˜…äº‹ä»¶"]
        CL7["7.åˆå§‹åŒ–newMsgBus"]
    end
    
    LogicReady --> CL1 --> CL2 --> CL3 --> CL4 --> CL5 --> CL6 --> CL7
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green">ğŸ“‚</div>
                    <h2>é¢‘é“åˆå§‹åŒ–ä¸æ•°æ®åŒæ­¥</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph InitChannel["initChannelè·å–é¢‘é“ä¿¡æ¯"]
        IC1["channelManager.getChannel"]
        IC2{"channel==null?"}
        IC3["getChannelä»æœåŠ¡å™¨è·å–"]
        IC4["fetchChannelInfoå¼‚æ­¥æ›´æ–°"]
        IC5["æ›´æ–°åˆ°UI"]
    end
    
    IC1 --> IC2
    IC2 -->|æ˜¯| IC3 --> IC5
    IC2 -->|å¦| IC4 --> IC5
    
    subgraph InitSync["initSyncåŒæ­¥æ•°æ®"]
        IS1["syncPinnedMessages"]
        IS2["resetReminder"]
        IS3["syncMsgExtra"]
        IS4["syncReactions"]
        IS5{"ç¾¤èŠ?"}
        IS6["syncGroupMembers"]
        IS7["syncLatestSchedule"]
        IS8["initDraft"]
    end
    
    IS1 --> IS2 --> IS3 --> IS4 --> IS5
    IS5 -->|æ˜¯| IS6 --> IS7
    IS5 -->|å¦| IS7
    IS7 --> IS8
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-orange">ğŸ“¨</div>
                    <h2>æ¶ˆæ¯åŠ è½½æµç¨‹ (ChatMsgController)</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["ChatMsgController.onReady"])
    
    Start --> A["åˆå§‹åŒ–taskLoadMoreQueue"]
    A --> B["addListener"]
    
    subgraph ListenersConfig["ç›‘å¬å™¨é…ç½®"]
        LC1["stateListener:applyContainerState"]
        LC2["markAsReadCallback:clearUnread"]
    end
    
    B --> LC1
    B --> LC2
    
    LC2 --> C["startRefresh"]
    C --> D["doInit"]
    
    D --> E{"isFromPinnedMsg?"}
    E -->|æ˜¯| F["ä½¿ç”¨ä¼ å…¥çš„ç½®é¡¶æ¶ˆæ¯åˆ—è¡¨"]
    E -->|å¦| G["initializeConversation"]
    
    subgraph SDKLoad["SDKå†…éƒ¨å¤„ç†"]
        SDL1["ä»æœ¬åœ°æ•°æ®åº“åŠ è½½æ¶ˆæ¯"]
        SDL2{"æœ¬åœ°æ¶ˆæ¯è¶³å¤Ÿ?"}
        SDL3["è§¦å‘ç½‘ç»œåŒæ­¥"]
        SDL4["é€šçŸ¥stateListeneræ›´æ–°UI"]
    end
    
    G --> SDL1 --> SDL2
    SDL2 -->|å¦| SDL3 --> SDL4
    SDL2 -->|æ˜¯| SDL4
    
    SDL4 --> ApplyNode["applyContainerState"]
    
    subgraph ApplyState["applyContainerStateå¤„ç†"]
        AS1["messages.valueåè½¬"]
        AS2["isCanPullDown.value"]
        AS3["isCanPullUp.value"]
        AS4["æ›´æ–°åŠ è½½çŠ¶æ€"]
        AS5["å¤„ç†æœªè¯»æ¶ˆæ¯å®šä½"]
    end
    
    ApplyNode --> AS1 --> AS2 --> AS3 --> AS4 --> AS5
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-cyan">ğŸ”„</div>
                    <h2>æ¶ˆæ¯åŒæ­¥æ¸²æŸ“æµç¨‹ï¼ˆæœ¬åœ°/ç½‘ç»œåŒæ­¥æœºåˆ¶ï¼‰</h2>
                </div>
                
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 10px;">ğŸ’¡ å®Œæ•´çš„æ¶ˆæ¯åŒæ­¥æ¸²æŸ“æ¶æ„ï¼ŒåŒ…å«æœ¬åœ°æ•°æ®åº“åŠ è½½ã€ç½‘ç»œåŒæ­¥ã€æ•°æ®ä¿å­˜ã€å›è°ƒæ¸²æŸ“ç­‰æ ¸å¿ƒæµç¨‹</p>
                
                <h3>1. æ ¸å¿ƒæ¶æ„æ¦‚è§ˆ</h3>
                <div class="mermaid">
flowchart TB
    subgraph UI["UIå±‚"]
        ChatPage["ChatPage"]
        ChatLogic["ChatLogic"]
        ChatMsgController["ChatMsgController"]
    end
    
    subgraph Manager["æ¶ˆæ¯ç®¡ç†å±‚"]
        ConvMsgManager["ConversationMessageManager"]
        StateUpdater["ConversationStateUpdater"]
        ContinuityChecker["MessageContinuityChecker"]
        DeletedHandler["DeletedMessagePlaceholderHandler"]
    end
    
    subgraph Container["æ•°æ®å®¹å™¨å±‚"]
        MsgContainer["ConversationMessageContainer"]
        MsgList["messages: List&lt;WKMsg&gt;"]
        StateInfo["çŠ¶æ€ä¿¡æ¯: hasMore/isSyncing/state"]
    end
    
    subgraph DataProvider["æ•°æ®æä¾›å±‚"]
        DefaultProvider["DefaultConversationMessageDataProvider"]
        MessageDB["MessageDBæœ¬åœ°æ•°æ®åº“"]
        WKIM_SDK["WKIM SDKç½‘ç»œåŒæ­¥"]
    end
    
    ChatPage --> ChatLogic
    ChatLogic --> ChatMsgController
    ChatMsgController --> ConvMsgManager
    
    ConvMsgManager --> StateUpdater
    ConvMsgManager --> ContinuityChecker
    ConvMsgManager --> DeletedHandler
    ConvMsgManager --> MsgContainer
    
    MsgContainer --> MsgList
    MsgContainer --> StateInfo
    
    ConvMsgManager --> DefaultProvider
    DefaultProvider --> MessageDB
    DefaultProvider --> WKIM_SDK
                </div>
                
                <h3>2. åˆå§‹åŒ–æ¶ˆæ¯åŠ è½½æµç¨‹</h3>
                <div class="mermaid">
sequenceDiagram
    participant UI as ChatMsgController
    participant Manager as ConversationMessageManager
    participant Container as MessageContainer
    participant DB as MessageDB
    participant Server as WKIM_SDK
    
    Note over UI,Server: è¿›å…¥èŠå¤©é¡µè§¦å‘åˆå§‹åŒ–
    
    UI->>Manager: initializeConversation(anchorOrderSeq)
    Manager->>Manager: _taskQueue.push()ä¸²è¡Œæ‰§è¡Œ
    
    Note over Manager: 1. ç¡®å®šé”šç‚¹å’Œæ‹‰å–æ¨¡å¼
    Manager->>Manager: åˆ¤æ–­anchorOrderSeqä½ç½®
    
    alt anchorOrderSeq > 0 æŒ‡å®šé”šç‚¹
        Manager->>Manager: è®¡ç®—actualAnchor
        Manager->>Manager: åˆ¤æ–­æ˜¯å¦æ¥è¿‘æœ€åä¸€é¡µ
    else anchorOrderSeq = 0 é»˜è®¤æœ€æ–°
        Manager->>Manager: ä½¿ç”¨lastOrderSeqWithLocation
    end
    
    Note over Manager: 2. æŸ¥è¯¢æœ¬åœ°è¿ç»­æ¶ˆæ¯å—
    Manager->>DB: queryFirstContinuousBlockAboveAnchor
    DB-->>Manager: localMessages
    
    Manager->>Manager: æ£€æŸ¥æ¶ˆæ¯è¿ç»­æ€§
    Manager->>Container: replaceMessages(localMessages)
    Container->>UI: stateListenerå›è°ƒ
    UI->>UI: applyContainerStateæ›´æ–°UI
    
    Note over Manager: 3. åˆ¤æ–­æ˜¯å¦éœ€è¦ç½‘ç»œåŒæ­¥
    Manager->>Manager: prepareSyncMessagesFromInit
    
    alt æœ¬åœ°æ•°æ®å……è¶³
        Manager->>Manager: ç›´æ¥å®Œæˆåˆå§‹åŒ–
    else éœ€è¦ç½‘ç»œåŒæ­¥
        Manager->>Server: syncChannelMsg
        Server-->>Manager: WKSyncChannelMsg
        Manager->>DB: ä¿å­˜æ¶ˆæ¯åˆ°æ•°æ®åº“
        Manager->>Manager: æ£€æµ‹å¹¶ä¿å­˜å·²åˆ é™¤æ¶ˆæ¯å ä½ç¬¦
        Manager->>DB: é‡æ–°æŸ¥è¯¢æœ¬åœ°æ¶ˆæ¯
        DB-->>Manager: newMessages
        Manager->>Manager: handleSyncedMessages
        Manager->>Container: æ›´æ–°æ¶ˆæ¯åˆ—è¡¨
        Container->>UI: stateListenerå›è°ƒ
        UI->>UI: applyContainerStateæ›´æ–°UI
    end
    
    Manager->>Manager: _onInitFinished
    Manager->>Container: isFirstSyncFinish=true
                </div>
                
                <h3>3. æœ¬åœ°æ¶ˆæ¯æŸ¥è¯¢ä¸è¿ç»­æ€§åˆ¤æ–­</h3>
                <div class="mermaid">
flowchart TD
    Start(["_queryLocalMessages"])
    
    Start --> A["MessageDB.getMessagesæŸ¥è¯¢æ•°æ®åº“"]
    A --> B["æŒ‰orderSeqæ’åº"]
    B --> C["getContinuousMessagesæ£€æŸ¥è¿ç»­æ€§"]
    
    subgraph ContinuityCheck["è¿ç»­æ€§æ£€æŸ¥"]
        CC1["è·å–å·²åˆ é™¤æ¶ˆæ¯åºå·é›†åˆ"]
        CC2["éå†æ¶ˆæ¯æ£€æŸ¥gap"]
        CC3{"msgSeqå·®å€¼ > 1?"}
        CC4["æ£€æŸ¥gapæ˜¯å¦éƒ½æ˜¯å·²åˆ é™¤æ¶ˆæ¯"]
        CC5{"å…¨éƒ¨å·²åˆ é™¤?"}
        CC6["è®¤ä¸ºè¿ç»­"]
        CC7["è®¤ä¸ºä¸è¿ç»­,æˆªæ–­"]
    end
    
    C --> CC1 --> CC2 --> CC3
    CC3 -->|æ˜¯| CC4 --> CC5
    CC5 -->|æ˜¯| CC6
    CC5 -->|å¦| CC7
    CC3 -->|å¦| CC6
    
    CC6 --> D["è¿”å›è¿ç»­æ¶ˆæ¯åˆ—è¡¨"]
    CC7 --> D
    
    subgraph DeletedMsgLogic["å·²åˆ é™¤æ¶ˆæ¯å¤„ç†"]
        DM1["deleted_messageè¡¨è®°å½•å·²åˆ é™¤çš„msgSeq"]
        DM2["æœåŠ¡å™¨è¿”å›æ¶ˆæ¯æ—¶æ£€æµ‹gap"]
        DM3["å°†gapä¸­çš„seqä¿å­˜ä¸ºå·²åˆ é™¤å ä½ç¬¦"]
    end
                </div>
                
                <h3>4. ç½‘ç»œåŒæ­¥æµç¨‹è¯¦è§£</h3>
                <div class="mermaid">
sequenceDiagram
    participant Manager as ConversationMessageManager
    participant Provider as DataProvider
    participant SDK as WKIM_SDK
    participant Server as IMæœåŠ¡å™¨
    participant DB as æœ¬åœ°æ•°æ®åº“
    
    Note over Manager,DB: ç½‘ç»œåŒæ­¥è§¦å‘æ—¶æœº
    
    Manager->>Manager: _syncMessagesFromServer
    Manager->>Manager: container.isSyncing=true
    Manager->>Manager: container.state=loading
    Manager->>Manager: _notifyStateChangeæ›´æ–°UI
    
    Manager->>Provider: syncChannelMsg(startSeq,endSeq,limit,pullMode)
    Provider->>SDK: setSyncChannelMsgListener
    SDK->>Server: è¯·æ±‚åŒæ­¥æ¶ˆæ¯
    
    Server-->>SDK: è¿”å›WKSyncChannelMsg
    Note right of Server: messages/more/offsetMsgSeq
    
    SDK-->>Provider: å›è°ƒsyncResult
    Provider-->>Manager: WKSyncChannelMsg
    
    alt åŒæ­¥æˆåŠŸ
        Manager->>Manager: _saveDeletedMessagePlaceholders
        Note over Manager: æ£€æµ‹æœåŠ¡å™¨æ¶ˆæ¯gap,ä¿å­˜å·²åˆ é™¤å ä½ç¬¦
        
        Manager->>Manager: _updateConversationMsgSeq
        Note over Manager: more=0æ—¶æ›´æ–°offset_msg_seqæˆ–last_msg_seq
        
        Manager->>DB: é‡æ–°æŸ¥è¯¢æœ¬åœ°æ¶ˆæ¯
        DB-->>Manager: newMessages
        
        Manager->>Manager: handleSyncedMessages
        Manager->>Manager: checkMessageContinuity
        
        alt ä¸ç°æœ‰æ¶ˆæ¯è¿ç»­
            Manager->>Manager: addMessagesæ·»åŠ 
        else ä¸è¿ç»­
            Manager->>Manager: replaceMessagesæ›¿æ¢
        end
        
        Manager->>Manager: container.state=completed
    else åŒæ­¥å¤±è´¥
        Manager->>Manager: container.state=failed
    end
    
    Manager->>Manager: container.isSyncing=false
    Manager->>Manager: _notifyStateChangeæ›´æ–°UI
                </div>
                
                <h3>5. åŠ è½½æ›´å¤šæ¶ˆæ¯æµç¨‹</h3>
                <div class="mermaid">
flowchart TD
    Start(["loadMore(pullMode)"])
    
    Start --> A{"æ£€æŸ¥è¾¹ç•Œ"}
    A -->|pullHistoryä¸”!hasMoreHistory| B["ç›´æ¥è¿”å›completed"]
    A -->|pullNewä¸”!hasMoreNew| B
    A -->|å¯ä»¥åŠ è½½| C["è®¾ç½®loadingçŠ¶æ€"]
    
    C --> D["è·å–é”šç‚¹æ¶ˆæ¯"]
    D --> E{"pullModeæ–¹å‘"}
    E -->|pullHistory| F["ä½¿ç”¨oldestMessage"]
    E -->|pullNew| G["ä½¿ç”¨newestMessage"]
    
    F --> H["_queryLocalMessagesæŸ¥è¯¢æœ¬åœ°"]
    G --> H
    
    H --> I{"æœ¬åœ°æœ‰æ•°æ®?"}
    I -->|æ˜¯| J["addMessagesæ·»åŠ åˆ°åˆ—è¡¨"]
    J --> K["state=completed"]
    K --> L["_notifyStateChange"]
    
    I -->|å¦| M["_syncMessagesFromLoadMore"]
    M --> N["è®¡ç®—startOrderSeq"]
    N --> O["_syncMessagesFromServer"]
    O --> P["onCompleteå›è°ƒ"]
    P --> Q["addMessagesæ·»åŠ "]
    Q --> K
    
    O --> R["onErrorå›è°ƒ"]
    R --> S["state=failed"]
    S --> L
                </div>
                
                <h3>6. çŠ¶æ€æ›´æ–°ä¸UIæ¸²æŸ“æµç¨‹</h3>
                <div class="mermaid">
sequenceDiagram
    participant Manager as ConversationMessageManager
    participant Updater as ConversationStateUpdater
    participant Container as MessageContainer
    participant Controller as ChatMsgController
    participant UI as ChatPage
    
    Note over Manager,UI: çŠ¶æ€æ›´æ–°è§¦å‘æ¸²æŸ“
    
    Manager->>Manager: _notifyStateChange
    Manager->>Updater: updateConversationStates
    
    Updater->>Updater: queryConversationæŸ¥è¯¢ä¼šè¯
    Updater->>Updater: queryMaxOrderSeqæŸ¥è¯¢æœ€å¤§åºå·
    
    Updater->>Container: æ›´æ–°offsetMsgSeq
    Updater->>Container: æ›´æ–°lastMsgSeq
    Updater->>Container: æ›´æ–°lastReadMsgSeq
    Updater->>Container: æ›´æ–°unreadCount
    
    Updater->>Updater: _checkHasMoreHistory
    Updater->>Container: hasMoreHistory
    
    Updater->>Updater: _checkHasMoreNew
    Updater->>Container: hasMoreNew
    
    Manager->>Controller: stateListenerå›è°ƒ
    
    Controller->>Controller: applyContainerState
    Controller->>Controller: messages.value=container.messages.reversed
    Controller->>Controller: isCanPullDown.value=hasMoreHistory
    Controller->>Controller: isCanPullUp.value=hasMoreNew
    Controller->>Controller: æ›´æ–°pullDownLoadStatus/pullUpLoadStatus
    Controller->>Controller: å¤„ç†æœªè¯»æ¶ˆæ¯å®šä½
    
    Controller->>UI: Rxå“åº”å¼æ›´æ–°
    UI->>UI: ListViewé‡æ–°æ¸²æŸ“
                </div>
                
                <h3>7. æ–°æ¶ˆæ¯æ¥æ”¶ä¸æ¸²æŸ“æµç¨‹</h3>
                <div class="mermaid">
sequenceDiagram
    participant SDK as WKIM_SDK
    participant Logic as ChatLogic
    participant Bus as BatchMessageBus
    participant Manager as ConversationMessageManager
    participant Container as MessageContainer
    participant Scroll as ChatScrollController
    participant UI as ChatPage
    
    Note over SDK,UI: æ”¶åˆ°æ–°æ¶ˆæ¯
    
    SDK->>Logic: OnNewMsgListener(msgs)
    Logic->>Logic: è¿‡æ»¤å½“å‰é¢‘é“æ¶ˆæ¯
    Logic->>Bus: push(_NewMsgTask)
    
    Note over Bus: 300msé˜²æŠ–æ‰¹é‡å¤„ç†
    
    Bus->>Logic: handler(batch)
    Logic->>Logic: _receivedMessages
    
    Logic->>Manager: checkMessageContinuity
    Manager-->>Logic: isContinue
    
    alt æ¶ˆæ¯ä¸è¿ç»­
        Logic->>Logic: loadFooterDataåŠ è½½æ›´å¤š
    else æ¶ˆæ¯è¿ç»­
        Logic->>Logic: è¿‡æ»¤ä¸æ˜¾ç¤ºçš„æ¶ˆæ¯ç±»å‹
        Logic->>Logic: æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨
        Logic->>Manager: addNewMessage(insertMessages)
        Manager->>Container: æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
        Manager->>Logic: stateListenerå›è°ƒ
        
        alt æ»šåŠ¨ä½ç½®<=500
            Logic->>Logic: _unreadManager.markBottomAsRead
            Logic->>Scroll: jumpToBottom
        else æ»šåŠ¨ä½ç½®è¾ƒè¿œ
            Logic->>Logic: updateIndicatorVisible
            Logic->>UI: æ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤ºæŒ‰é’®
        end
    end
    
    Logic->>UI: messages.refresh()
                </div>
                
                <h3>8. å‘é€æ¶ˆæ¯å…¥åº“ä¸æ¸²æŸ“æµç¨‹</h3>
                <div class="mermaid">
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Logic as ChatLogic
    participant SendUtils as ChatSendUtils
    participant SDK as WKIM_SDK
    participant DB as æœ¬åœ°æ•°æ®åº“
    participant Manager as ConversationMessageManager
    participant Scroll as ChatScrollController
    participant UI as ChatPage
    
    User->>Logic: ç‚¹å‡»å‘é€
    Logic->>SendUtils: sendTextMessage
    SendUtils->>SDK: WKIM.shared.messageManager.sendMessage
    
    SDK->>SDK: ç”ŸæˆclientMsgNO
    SDK->>DB: æ¶ˆæ¯å…¥åº“(status=sending)
    SDK->>Logic: OnMsgInsertedListener
    
    Logic->>Logic: _receivedMessages(isSendMsg=true)
    Logic->>Manager: addNewMessage
    Manager->>Manager: æ·»åŠ æ¶ˆæ¯åˆ°åˆ—è¡¨
    Manager->>Logic: stateListenerå›è°ƒ
    
    Logic->>Scroll: jumpToBottom
    Logic->>UI: æ˜¾ç¤ºå‘é€ä¸­çŠ¶æ€
    
    Note over SDK: æ¶ˆæ¯å‘é€åˆ°æœåŠ¡å™¨
    
    SDK->>SDK: å‘é€å®Œæˆ
    SDK->>DB: æ›´æ–°status/messageSeq
    SDK->>Logic: OnRefreshMsgListener
    
    Logic->>Manager: updateMessage
    Manager->>Manager: æ›´æ–°æ¶ˆæ¯çŠ¶æ€
    Manager->>Logic: stateListenerå›è°ƒ
    
    alt messageSeqä»0å˜ä¸ºé0
        Logic->>Scroll: jumpToBottom
    end
    
    Logic->>UI: æ›´æ–°æ¶ˆæ¯çŠ¶æ€æ˜¾ç¤º
                </div>
                
                <h3>9. ä¼šè¯åŒæ­¥äº‹ä»¶å¤„ç†</h3>
                <div class="mermaid">
flowchart TD
    Start(["ConversationSyncEvent"])
    
    Start --> A["eventBusç›‘å¬åˆ°äº‹ä»¶"]
    A --> B{"channelIDåŒ¹é…?"}
    B -->|å¦| C["å¿½ç•¥"]
    B -->|æ˜¯| D["è·å–å½“å‰æœ€å¤§æ¶ˆæ¯åºå·"]
    
    D --> E{"maxMsgSeq > currentMaxSeq?"}
    E -->|å¦| F["æ— éœ€å¤„ç†"]
    E -->|æ˜¯| G["onConversationSynced"]
    
    G --> H["updateConversationStates"]
    H --> I["loadFooterData(isForce=true)"]
    I --> J["åŠ è½½æ–°æ¶ˆæ¯"]
    J --> K["æ›´æ–°UI"]
    
    subgraph SyncTrigger["åŒæ­¥è§¦å‘æ—¶æœº"]
        T1["IMè¿æ¥æˆåŠŸåè‡ªåŠ¨åŒæ­¥"]
        T2["ä¼šè¯åˆ—è¡¨åˆ·æ–°æ—¶"]
        T3["Appæ¢å¤å‰å°æ—¶"]
    end
                </div>
                
                <h3>10. æ¶ˆæ¯å®¹å™¨çŠ¶æ€ç®¡ç†</h3>
                <div class="mermaid">
flowchart LR
    subgraph Container["ConversationMessageContainer"]
        direction TB
        C1["channelId/channelType"]
        C2["messages: List&lt;WKMsg&gt;"]
        C3["state: loading/completed/failed"]
        C4["direction: pullHistory/pullNew"]
        C5["uiLoadPosition: top/bottom"]
        C6["hasMoreHistory: bool"]
        C7["hasMoreNew: bool"]
        C8["isSyncing: bool"]
        C9["isFirstSyncFinish: bool"]
        C10["offsetMsgSeq: èµ·å§‹åºå·"]
        C11["lastMsgSeq: æœ€ååºå·"]
        C12["lastReadMsgSeq: å·²è¯»åºå·"]
        C13["unreadCount: æœªè¯»æ•°"]
    end
    
    subgraph StateTransition["çŠ¶æ€è½¬æ¢"]
        ST1["idle"] -->|"startRefresh"| ST2["loading"]
        ST2 -->|"åŒæ­¥æˆåŠŸ"| ST3["completed"]
        ST2 -->|"åŒæ­¥å¤±è´¥"| ST4["failed"]
        ST4 -->|"é‡è¯•"| ST2
        ST3 -->|"loadMore"| ST2
    end
    
    subgraph UIMapping["UIçŠ¶æ€æ˜ å°„"]
        UM1["loading â†’ æ˜¾ç¤ºåŠ è½½è¿›åº¦"]
        UM2["completed â†’ éšè—åŠ è½½è¿›åº¦"]
        UM3["failed â†’ æ˜¾ç¤ºé”™è¯¯æç¤º"]
        UM4["hasMoreHistory â†’ ä¸‹æ‹‰åˆ·æ–°å¯ç”¨"]
        UM5["hasMoreNew â†’ ä¸Šæ‹‰åŠ è½½å¯ç”¨"]
        UM6["uiLoadPosition â†’ è¿›åº¦æ¡ä½ç½®"]
    end
                </div>
                
                <div class="flow-description">
                    <h4>æ¶ˆæ¯åŒæ­¥æ¸²æŸ“æ ¸å¿ƒè¦ç‚¹</h4>
                    <ul>
                        <li><span class="step-number">1</span><strong>æœ¬åœ°ä¼˜å…ˆç­–ç•¥</strong> - ä¼˜å…ˆä»æœ¬åœ°æ•°æ®åº“åŠ è½½æ¶ˆæ¯ï¼Œå¿«é€Ÿæ˜¾ç¤ºUIï¼Œå†å¼‚æ­¥åŒæ­¥ç½‘ç»œæ•°æ®</li>
                        <li><span class="step-number">2</span><strong>è¿ç»­æ€§æ£€æŸ¥</strong> - é€šè¿‡MessageContinuityCheckeræ£€æŸ¥æ¶ˆæ¯åºå·è¿ç»­æ€§ï¼Œå¤„ç†å·²åˆ é™¤æ¶ˆæ¯å ä½ç¬¦</li>
                        <li><span class="step-number">3</span><strong>å¢é‡åŒæ­¥</strong> - æ ¹æ®anchorOrderSeqå’ŒpullModeç¡®å®šåŒæ­¥èŒƒå›´ï¼Œé¿å…é‡å¤åŠ è½½</li>
                        <li><span class="step-number">4</span><strong>çŠ¶æ€å®¹å™¨</strong> - ConversationMessageContainerç»´æŠ¤æ¶ˆæ¯åˆ—è¡¨å’Œå„ç§çŠ¶æ€ï¼Œæ”¯æŒå“åº”å¼æ›´æ–°</li>
                        <li><span class="step-number">5</span><strong>ä»»åŠ¡é˜Ÿåˆ—</strong> - TaskQueueç¡®ä¿initializeConversationå’ŒloadMoreä¸²è¡Œæ‰§è¡Œï¼Œé¿å…å¹¶å‘é—®é¢˜</li>
                        <li><span class="step-number">6</span><strong>æ‰¹é‡å¤„ç†</strong> - BatchMessageBuså¯¹æ–°æ¶ˆæ¯è¿›è¡Œ300msé˜²æŠ–æ‰¹é‡å¤„ç†ï¼Œå‡å°‘UIåˆ·æ–°æ¬¡æ•°</li>
                        <li><span class="step-number">7</span><strong>è¾¹ç•Œç®¡ç†</strong> - hasMoreHistory/hasMoreNewç»“åˆoffsetMsgSeq/lastMsgSeqåˆ¤æ–­æ˜¯å¦è¿˜æœ‰æ›´å¤šæ¶ˆæ¯</li>
                        <li><span class="step-number">8</span><strong>å·²åˆ é™¤æ¶ˆæ¯</strong> - æœåŠ¡å™¨è¿”å›æ¶ˆæ¯æ—¶æ£€æµ‹gapï¼Œä¿å­˜ä¸ºå·²åˆ é™¤å ä½ç¬¦ï¼Œç¡®ä¿è¿ç»­æ€§åˆ¤æ–­å‡†ç¡®</li>
                        <li><span class="step-number">9</span><strong>UIä½ç½®åˆ†ç¦»</strong> - uiLoadPositionä¸æ•°æ®directionåˆ†ç¦»ï¼Œæ”¯æŒ"å‘å‰æ‹‰å–ä½†è¿›åº¦æ¡åœ¨åº•éƒ¨"ç­‰åœºæ™¯</li>
                        <li><span class="step-number">10</span><strong>æœªè¯»ç®¡ç†</strong> - ChatUnreadManageråŠ¨æ€è®¡ç®—å·²è¯»èŒƒå›´å¤–çš„æœªè¯»æ•°ï¼Œæ”¯æŒåˆ†å‰²çº¿æ˜¾ç¤º</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ‘‚</div>
                    <h2>ChatLogic æ¶ˆæ¯ç›‘å¬å™¨</h2>
                </div>
                
                <h3>ç›‘å¬å™¨åˆ—è¡¨</h3>
                <div class="mermaid">
flowchart LR
    subgraph Listeners["initMessageListener æ³¨å†Œçš„ 10 ä¸ªç›‘å¬å™¨"]
        L1["1. OnRefreshListener - é¢‘é“èµ„æ–™åˆ·æ–°"]
        L2["2. OnMsgInsertedListener - æ¶ˆæ¯å…¥åº“"]
        L3["3. OnNewMsgListener - æ–°æ¶ˆæ¯"]
        L4["4. OnRefreshMsgListener - æ¶ˆæ¯çŠ¶æ€åˆ·æ–°"]
        L5["5. OnRefreshMsgListListener - ä¼šè¯åˆ—è¡¨åˆ·æ–°"]
        L6["6. OnDeleteMsgListener - åˆ é™¤æ¶ˆæ¯"]
        L7["7. OnClearChannelMsgListener - æ¸…é™¤é¢‘é“æ¶ˆæ¯"]
        L8["8. OnNewReminderListener - @æ¶ˆæ¯æé†’"]
        L9["9. channelMemberManager - ç¾¤æˆå‘˜å˜åŒ–"]
        L10["10. OnCmdListener - CMDå‘½ä»¤"]
    end
                </div>
                
                <h3>1. OnRefreshListener (Channel) å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H1A["è§¦å‘: é¢‘é“èµ„æ–™æ›´æ–°"] --> H1B{"channelIDåŒ¹é…?"} 
    H1B -->|æ˜¯| H1C["æ›´æ–° channel.value"] --> H1D["è§¦å‘æ ‡é¢˜æ UIæ›´æ–°"]
    H1B -->|å¦| H1E["å¿½ç•¥"]
                </div>
                
                <h3>2. OnMsgInsertedListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H2A["è§¦å‘: å‘é€æ¶ˆæ¯å…¥åº“è¿”å›"] --> H2B["è¿‡æ»¤å½“å‰é¢‘é“æ¶ˆæ¯"] --> H2C["_receivedMessages isSendMsg=true"] --> H2D["æ’å…¥æ¶ˆæ¯åˆ°åˆ—è¡¨"] --> H2E["è·³è½¬åˆ°åº•éƒ¨"]
                </div>
                
                <h3>3. OnNewMsgListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H3A["è§¦å‘: æ”¶åˆ°æ–°æ¶ˆæ¯"] --> H3B["è¿‡æ»¤å½“å‰é¢‘é“æ¶ˆæ¯"] --> H3C["newMsgBus.push æ‰¹é‡å¤„ç†"] --> H3D["_receivedMessages isSendMsg=false"]
    
    subgraph ReceivedProcess["_receivedMessages å¤„ç†"]
        R1["æ£€æŸ¥æ¶ˆæ¯è¿ç»­æ€§"]
        R2{"è¿ç»­?"}
        R3["è¿‡æ»¤ä¸æ˜¾ç¤ºçš„æ¶ˆæ¯ç±»å‹"]
        R4["æ£€æŸ¥æ¶ˆæ¯æ˜¯å¦å·²å­˜åœ¨"]
        R5["æ’å…¥æ¶ˆæ¯åˆ°åˆ—è¡¨"]
        R6{"æ˜¯é€šè¯æ¶ˆæ¯?"}
        R7["VideoCallLogic.handleCall"]
        R8{"æ»šåŠ¨ä½ç½®<=500?"}
        R9["è·³è½¬åˆ°åº•éƒ¨"]
        R10["æ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤º"]
    end
    
    H3D --> R1 --> R2
    R2 -->|å¦| LoadFooter["loadFooterData"]
    R2 -->|æ˜¯| R3 --> R4 --> R5 --> R6
    R6 -->|æ˜¯| R7 --> R8
    R6 -->|å¦| R8
    R8 -->|æ˜¯| R9
    R8 -->|å¦| R10
                </div>
                
                <h3>4. OnRefreshMsgListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H4A["è§¦å‘: æ¶ˆæ¯çŠ¶æ€æ›´æ–°"] --> H4B{"channelIDåŒ¹é…?"}
    H4B -->|æ˜¯| H4C{"isMutualDeleted==1?"}
    H4C -->|æ˜¯| H4D["ä»åˆ—è¡¨ç§»é™¤æ¶ˆæ¯"]
    H4C -->|å¦| H4E["updateMessage æ›´æ–°æ¶ˆæ¯çŠ¶æ€"]
    H4E --> H4F{"messageSeqä»0å˜ä¸ºé0?"}
    H4F -->|æ˜¯| H4G["jumpToBottom è·³è½¬åˆ°åº•éƒ¨"]
    H4B -->|å¦| H4H["å¿½ç•¥"]
                </div>
                
                <h3>5. OnRefreshMsgListListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H5A["è§¦å‘: ä¼šè¯åˆ—è¡¨åˆ·æ–°"] --> H5B["éå†msgs"] --> H5C{"channelIDåŒ¹é…?"}
    H5C -->|æ˜¯| H5D["_refreshChatBg åˆ·æ–°èŠå¤©èƒŒæ™¯"]
    H5C -->|å¦| H5E["å¿½ç•¥"]
                </div>
                
                <h3>6. OnDeleteMsgListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H6A["è§¦å‘: åˆ é™¤æ¶ˆæ¯"] --> H6B["remoteMessageByClientMsgNo"] --> H6C["ä»æ¶ˆæ¯åˆ—è¡¨ç§»é™¤"]
                </div>
                
                <h3>7. OnClearChannelMsgListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H7A["è§¦å‘: æ¸…é™¤é¢‘é“èŠå¤©è®°å½•"] --> H7B{"channelIDåŒ¹é…?"}
    H7B -->|æ˜¯| H7C["clearConversation æ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨"] --> H7D["clearPinnedMessage æ¸…ç©ºç½®é¡¶"] --> H7E["updateIndicatorVisible"]
    H7B -->|å¦| H7F["å¿½ç•¥"]
                </div>
                
                <h3>8. OnNewReminderListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H8A["è§¦å‘: æ”¶åˆ°@æ¶ˆæ¯æé†’"] --> H8B["resetReminder é‡ç½®æé†’çŠ¶æ€"]
                </div>
                
                <h3>9. channelMemberManager ç¾¤æˆå‘˜ç›‘å¬</h3>
                <div class="mermaid">
flowchart LR
    subgraph MemberListeners["ä¸‰ä¸ªç¾¤æˆå‘˜ç›‘å¬å™¨"]
        M1["OnNewMemberListener"]
        M2["OnDeleteMemberListener"]
        M3["OnRefreshMemberListener"]
    end
    
    M1 --> M1A["è¿‡æ»¤å½“å‰ç¾¤æˆå‘˜"] --> M1B["channelMembers.addAll æ·»åŠ æˆå‘˜"]
    M2 --> M2A["è·å–æˆå‘˜IDåˆ—è¡¨"] --> M2B["channelMembers.removeWhere ç§»é™¤æˆå‘˜"]
    M3 --> M3A{"isEnd==true?"}
    M3A -->|æ˜¯| M3B["é‡æ–°è·å–å…¨éƒ¨æˆå‘˜"] --> M3C["æ¸…é™¤æ¶ˆæ¯å‘é€è€…ç¼“å­˜"] --> M3D["messages.refresh"]
    M3A -->|å¦| M3E["ç­‰å¾…ä¸‹ä¸€æ¬¡å›è°ƒ"]
                </div>
                
                <h3>10. OnCmdListener å¤„ç†</h3>
                <div class="mermaid">
flowchart LR
    H10A["è§¦å‘: æ”¶åˆ°CMDå‘½ä»¤"] --> H10B{"channelIDåŒ¹é…?"}
    H10B -->|æ˜¯| H10C{"cmdç±»å‹åˆ¤æ–­"}
    H10C -->|conversationMessageBothClear| H10D["clearPinnedMessage æ¸…ç©ºç½®é¡¶æ¶ˆæ¯"]
    H10B -->|å¦| H10E["å¿½ç•¥"]
                </div>
                
                <div class="flow-description">
                    <h4>ç›‘å¬å™¨è¯¦ç»†è¯´æ˜</h4>
                    <ul>
                        <li><span class="step-number">1</span><strong>OnRefreshListener (Channel)</strong> - é¢‘é“èµ„æ–™æ›´æ–°æ—¶è§¦å‘ï¼Œæ›´æ–°èŠå¤©é¡µæ ‡é¢˜æ æ˜¾ç¤ºçš„é¢‘é“åç§°ã€å¤´åƒç­‰ä¿¡æ¯</li>
                        <li><span class="step-number">2</span><strong>OnMsgInsertedListener</strong> - å‘é€æ¶ˆæ¯å…¥åº“åè§¦å‘ï¼Œå°†æ¶ˆæ¯æ’å…¥åˆ—è¡¨å¹¶è·³è½¬åˆ°åº•éƒ¨æ˜¾ç¤º</li>
                        <li><span class="step-number">3</span><strong>OnNewMsgListener</strong> - æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶è§¦å‘ï¼Œé€šè¿‡ newMsgBus æ‰¹é‡å¤„ç†ï¼Œæ£€æŸ¥æ¶ˆæ¯è¿ç»­æ€§ã€è¿‡æ»¤ç±»å‹ã€å¤„ç†é€šè¯æ¶ˆæ¯ã€æ›´æ–°UI</li>
                        <li><span class="step-number">4</span><strong>OnRefreshMsgListener</strong> - æ¶ˆæ¯çŠ¶æ€å˜åŒ–æ—¶è§¦å‘ï¼ˆå¦‚å‘é€æˆåŠŸ/å¤±è´¥ï¼‰ï¼Œå¤„ç†å¤šåˆ æ¶ˆæ¯ç§»é™¤ï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€</li>
                        <li><span class="step-number">5</span><strong>OnRefreshMsgListListener</strong> - ä¼šè¯åˆ—è¡¨åˆ·æ–°æ—¶è§¦å‘ï¼Œç”¨äºåˆ·æ–°èŠå¤©èƒŒæ™¯å›¾ç‰‡</li>
                        <li><span class="step-number">6</span><strong>OnDeleteMsgListener</strong> - åˆ é™¤æ¶ˆæ¯æ—¶è§¦å‘ï¼Œä»æ¶ˆæ¯åˆ—è¡¨ä¸­ç§»é™¤æŒ‡å®šæ¶ˆæ¯</li>
                        <li><span class="step-number">7</span><strong>OnClearChannelMsgListener</strong> - æ¸…é™¤é¢‘é“èŠå¤©è®°å½•æ—¶è§¦å‘ï¼Œæ¸…ç©ºæ¶ˆæ¯åˆ—è¡¨å’Œç½®é¡¶æ¶ˆæ¯</li>
                        <li><span class="step-number">8</span><strong>OnNewReminderListener</strong> - æ”¶åˆ°@æ¶ˆæ¯æé†’æ—¶è§¦å‘ï¼Œé‡ç½®æé†’çŠ¶æ€</li>
                        <li><span class="step-number">9</span><strong>channelMemberManager</strong> - åŒ…å«ä¸‰ä¸ªç›‘å¬å™¨ï¼šæ–°æˆå‘˜åŠ å…¥ã€æˆå‘˜ç§»é™¤ã€æˆå‘˜ä¿¡æ¯åˆ·æ–°ï¼Œç”¨äºç»´æŠ¤ç¾¤æˆå‘˜åˆ—è¡¨</li>
                        <li><span class="step-number">10</span><strong>OnCmdListener</strong> - æ”¶åˆ°æœåŠ¡ç«¯CMDå‘½ä»¤æ—¶è§¦å‘ï¼Œå¤„ç† conversationMessageBothClearï¼ˆåŒæ¸…ï¼‰å‘½ä»¤</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- æ¶ˆæ¯æ”¶å‘ -->
        <section id="message" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green">ğŸ“¤</div>
                    <h2>å‘é€æ¶ˆæ¯æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant User as User
    participant Input as ChatInput
    participant Logic as ChatLogic
    participant Utils as SendUtils
    participant SDK as WKIM_SDK
    participant DB as LocalDB
    participant Server as Server
    participant UI as UILayer
    
    User->>Input: ç‚¹å‡»å‘é€æŒ‰é’®
    Input->>Logic: onMessageSendCallback
    Logic->>Utils: sendTextMessage
    
    Utils->>Utils: æ„å»ºWKTextContent
    Note right of Utils: è®¾ç½®æ–‡æœ¬å†…å®¹å’Œå›å¤å¼•ç”¨
    
    Utils->>SDK: sendMessage
    SDK->>SDK: ç”ŸæˆclientMsgNO
    SDK->>DB: æ¶ˆæ¯å…¥åº“
    SDK->>Logic: OnMsgInsertedListener
    Logic->>UI: æ˜¾ç¤ºæ¶ˆæ¯å‘é€ä¸­çŠ¶æ€
    
    SDK->>SDK: æ£€æŸ¥æ˜¯å¦éœ€è¦ä¸Šä¼ é™„ä»¶
    
    alt éœ€è¦ä¸Šä¼ é™„ä»¶
        SDK->>Utils: OnUploadAttachmentListener
        Utils->>Server: onUploadAttachment
    end
    
    SDK->>Server: å‘é€åˆ°æœåŠ¡å™¨
    
    alt å‘é€æˆåŠŸ
        Server-->>SDK: è¿”å›messageSeq
        SDK->>SDK: æ›´æ–°status
        SDK->>Logic: OnRefreshMsgListener
        Logic->>UI: æ›´æ–°æ¶ˆæ¯çŠ¶æ€æˆåŠŸ
    else å‘é€å¤±è´¥
        Server-->>SDK: å¤±è´¥å“åº”
        SDK->>SDK: status=sendFail
        SDK->>Logic: OnRefreshMsgListener
        Logic->>UI: æ˜¾ç¤ºå‘é€å¤±è´¥
    end
    
    Utils->>Input: æ¸…ç©ºè¾“å…¥æ¡†
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ“¥</div>
                    <h2>æ¥æ”¶æ¶ˆæ¯æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant Server as Server
    participant SDK as WKIM_SDK
    participant DB as LocalDB
    participant IMUtils as IMUtils
    participant ConvLogic as ConvLogic
    participant ChatLogicR as ChatLogic
    participant UI as UILayer
    
    Server->>SDK: æ¨é€æ–°æ¶ˆæ¯
    SDK->>SDK: 1.æ¶ˆæ¯è§£å¯†è§£ç 
    SDK->>DB: 2.æ¶ˆæ¯å…¥åº“
    
    SDK->>IMUtils: 3.OnNewMsgListenerå…¨å±€
    
    alt é€šè¯æ¶ˆæ¯
        IMUtils->>IMUtils: handleCall
    else ç¾¤ç³»ç»Ÿæ¶ˆæ¯
        IMUtils->>IMUtils: åŒæ­¥ç¾¤ä¿¡æ¯
    else æ™®é€šæ¶ˆæ¯
        IMUtils->>IMUtils: æ˜¾ç¤ºæœ¬åœ°é€šçŸ¥
    end
    
    SDK->>ConvLogic: 4.OnRefreshMsgListListener
    ConvLogic->>UI: æ›´æ–°ä¼šè¯åˆ—è¡¨
    
    Note over SDK,UI: å¦‚æœåœ¨èŠå¤©é¡µ
    
    SDK->>ChatLogicR: 5.OnNewMsgListener
    ChatLogicR->>ChatLogicR: newMsgBus.push
    ChatLogicR->>ChatLogicR: receivedMessages
    
    ChatLogicR->>ChatLogicR: æ£€æŸ¥æ¶ˆæ¯è¿ç»­æ€§
    ChatLogicR->>ChatLogicR: è¿‡æ»¤æ¶ˆæ¯ç±»å‹
    ChatLogicR->>ChatLogicR: addNewMessage
    
    alt æ»šåŠ¨ä½ç½®åœ¨å¯è§èŒƒå›´å†…
        ChatLogicR->>UI: æ»šåŠ¨åˆ°åº•éƒ¨
    else æ»šåŠ¨ä½ç½®è¾ƒè¿œ
        ChatLogicR->>UI: æ˜¾ç¤ºæ–°æ¶ˆæ¯æç¤º
    end
    
    ChatLogicR->>ChatLogicR: updateIndicatorVisible
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-orange">ğŸ”¢</div>
                    <h2>æœªè¯»æ•°ç®¡ç†æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph Source["æœªè¯»æ•°æ¥æº"]
        SRC1["ä¼šè¯åŒæ­¥æ—¶è·å–"]
        SRC2["æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶ç´¯åŠ "]
    end
    
    subgraph Update["æœªè¯»æ•°æ›´æ–°"]
        U1["è¿›å…¥èŠå¤©é¡µfinishTask"]
        U2["é˜…è¯»æ¶ˆæ¯onMessageViewed"]
        U3["é€€å‡ºèŠå¤©é¡µ"]
    end
    
    U1 --> C1["clearUnreadæ¸…é›¶"]
    U2 --> C2["ChatUnreadManager.update"]
    U3 --> C3["ä¸ŠæŠ¥å‰©ä½™æœªè¯»æ•°"]
    
    subgraph Display["æœªè¯»æ•°æ˜¾ç¤º"]
        D1["ä¼šè¯åˆ—è¡¨çº¢ç‚¹è§’æ ‡"]
        D2["åº•éƒ¨Tab Badge"]
        D3["æ¡Œé¢å›¾æ ‡è§’æ ‡"]
    end
    
    C1 --> D1
    C2 --> D2
    C3 --> D3
                </div>
            </div>
        </section>
        
        <!-- è”ç³»äººæ¨¡å— -->
        <section id="contact" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green">ğŸ‘¥</div>
                    <h2>è”ç³»äººæ¨¡å—æ•´ä½“æ¶æ„</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph UI["è”ç³»äººUIå±‚"]
        HomeContact["HomeContactPageè”ç³»äººé¦–é¡µ"]
        ContactPage["ContactPageè”ç³»äººåˆ—è¡¨"]
        NewFriends["FriendApplyListPageæ–°æœ‹å‹"]
        MyGroups["MyGroupsPageä¿å­˜çš„ç¾¤ç»„"]
        RobotList["RobotListPageæœºå™¨äººåˆ—è¡¨"]
        BlackList["BlackFriendPageé»‘åå•"]
    end
    
    subgraph Logic["ä¸šåŠ¡é€»è¾‘å±‚"]
        ContactLogic["ContactLogic"]
        ApplyLogic["FriendApplyListLogic"]
        GroupsLogic["MyGroupsLogic"]
    end
    
    subgraph Data["æ•°æ®å±‚"]
        WKIM["WKIM SDK"]
        HTTP["HTTP API"]
        ChannelManager["ChannelManager"]
    end
    
    HomeContact --> ContactPage
    HomeContact --> NewFriends
    HomeContact --> MyGroups
    HomeContact --> RobotList
    HomeContact --> BlackList
    
    ContactPage --> ContactLogic
    NewFriends --> ApplyLogic
    MyGroups --> GroupsLogic
    
    ContactLogic --> WKIM
    ContactLogic --> ChannelManager
    ApplyLogic --> HTTP
    GroupsLogic --> HTTP
                </div>
                
                <div class="architecture-grid">
                    <div class="arch-item">
                        <h4>ğŸ‘¥ è”ç³»äººé¦–é¡µ</h4>
                        <p>HomeContactPage åŒ…å«æ–°æœ‹å‹ã€æœºå™¨äººã€ä¿å­˜çš„ç¾¤ç»„ã€é»‘åå•å…¥å£åŠè”ç³»äººåˆ—è¡¨</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ“‹ è”ç³»äººåˆ—è¡¨</h4>
                        <p>ContactPage æ˜¾ç¤ºæ‰€æœ‰å¥½å‹ï¼Œæ”¯æŒå­—æ¯ç´¢å¼•ã€æœç´¢è¿‡æ»¤ã€ç‚¹å‡»è·³è½¬ç”¨æˆ·è¯¦æƒ…</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ†• æ–°æœ‹å‹</h4>
                        <p>FriendApplyListPage å±•ç¤ºå¥½å‹ç”³è¯·åˆ—è¡¨ï¼Œæ”¯æŒåŒæ„/æ‹’ç»æ“ä½œ</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ“ ä¿å­˜çš„ç¾¤ç»„</h4>
                        <p>MyGroupsPage å±•ç¤ºç”¨æˆ·åŠ å…¥çš„æ‰€æœ‰ç¾¤ç»„åˆ—è¡¨</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ“‹</div>
                    <h2>è”ç³»äººåˆ—è¡¨åŠ è½½æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["HomeContactPage.initState"])
    
    Start --> A["Get.put ContactLogic"]
    A --> B["ContactLogic.onReady"]
    
    subgraph LogicInit["ContactLogicåˆå§‹åŒ–"]
        L1["super.onReady"]
        L2["_initListener"]
    end
    
    B --> L1 --> L2
    
    L1 --> LoadData["loadData"]
    
    subgraph DataLoad["æ•°æ®åŠ è½½"]
        DL1["channelManager.getWithFollowAndStatus"]
        DL2["ä»æœ¬åœ°æ•°æ®åº“è·å–å¥½å‹åˆ—è¡¨"]
        DL3["è¿‡æ»¤follow=1ä¸”status=1çš„è”ç³»äºº"]
        DL4["return result"]
    end
    
    LoadData --> DL1 --> DL2 --> DL3 --> DL4
    
    DL4 --> Group["_groupåˆ†ç»„å¤„ç†"]
    
    subgraph GroupProcess["åˆ†ç»„æ’åº"]
        G1["è¿‡æ»¤ç³»ç»Ÿé¢‘é“"]
        G2["æŒ‰æ‹¼éŸ³é¦–å­—æ¯æ’åº"]
        G3["ç”ŸæˆgroupedIndexMap"]
        G4["æ›´æ–°letterså­—æ¯åˆ—è¡¨"]
    end
    
    Group --> G1 --> G2 --> G3 --> G4
    
    G4 --> UIUpdate["æ›´æ–°UI filterItems"]
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ‘‚</div>
                    <h2>ContactLogic ç›‘å¬å™¨</h2>
                </div>
                
                <div class="mermaid">
flowchart LR
    subgraph Listeners["initListeneræ³¨å†Œçš„ç›‘å¬å™¨"]
        L1["OnRefreshListeneråˆ·æ–°é¢‘é“ç›‘å¬"]
    end
    
    subgraph Handler["ç›‘å¬å™¨å¤„ç†"]
        H1["æ”¶åˆ°é¢‘é“æ›´æ–°äº‹ä»¶"]
        H2["æŸ¥æ‰¾å¯¹åº”è”ç³»äºº"]
        H3{"follow=0æˆ–isDeleted=1?"}
        H4["ä»åˆ—è¡¨ç§»é™¤"]
        H5["æ›´æ–°è”ç³»äººä¿¡æ¯"]
        H6["è§¦å‘UIåˆ·æ–°"]
    end
    
    L1 --> H1 --> H2 --> H3
    H3 -->|æ˜¯| H4 --> H6
    H3 -->|å¦| H5 --> H6
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-orange">ğŸ†•</div>
                    <h2>å¥½å‹ç”³è¯·å¤„ç†æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant User as User
    participant Page as FriendApplyListPage
    participant Logic as FriendApplyListLogic
    participant API as FriendApi
    participant Server as Server
    
    User->>Page: è¿›å…¥æ–°æœ‹å‹é¡µé¢
    Page->>Logic: onReady
    Logic->>API: friendApplyList
    API->>Server: è·å–ç”³è¯·åˆ—è¡¨
    Server-->>API: è¿”å›ç”³è¯·æ•°æ®
    API-->>Logic: List&lt;FriendApply&gt;
    Logic->>Page: æ›´æ–°UIæ˜¾ç¤ºåˆ—è¡¨
    
    User->>Page: ç‚¹å‡»åŒæ„æŒ‰é’®
    Page->>Logic: agreeApply(item)
    Logic->>API: agreeFriendApply
    API->>Server: åŒæ„å¥½å‹ç”³è¯·
    Server-->>API: æˆåŠŸå“åº”
    Logic->>Logic: refreshDataåˆ·æ–°åˆ—è¡¨
    Logic->>Page: æ›´æ–°UI
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-cyan">ğŸ”„</div>
                    <h2>è”ç³»äººåŒæ­¥æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant App as App
    participant MainTab as MainTabPage
    participant HTTP as HttpUtils
    participant Server as Server
    participant WKIM as WKIM_SDK
    participant DB as LocalDB
    participant EventBus as EventBus
    participant Contact as ContactPage
    
    Note over App,Contact: åº”ç”¨å¯åŠ¨åè§¦å‘è”ç³»äººåŒæ­¥
    
    MainTab->>MainTab: initialSync
    MainTab->>HTTP: syncFriends
    HTTP->>Server: è·å–å¥½å‹åˆ—è¡¨
    Server-->>HTTP: è¿”å›å¥½å‹æ•°æ®
    HTTP->>WKIM: æ›´æ–°é¢‘é“ä¿¡æ¯
    WKIM->>DB: ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“
    HTTP->>EventBus: å‘é€ContactSyncEvent
    EventBus->>Contact: è§¦å‘refreshData
    Contact->>Contact: é‡æ–°åŠ è½½è”ç³»äººåˆ—è¡¨
                </div>
            </div>
        </section>
        
        <!-- æˆ‘çš„æ¨¡å— -->
        <section id="mine" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-pink">ğŸ‘¤</div>
                    <h2>æˆ‘çš„æ¨¡å—æ•´ä½“æ¶æ„</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph UI["æˆ‘çš„UIå±‚"]
        MyPage["MyPageæˆ‘çš„é¦–é¡µ"]
        MyInfo["MyInfoPageä¸ªäººèµ„æ–™"]
        Security["SecurityPrivacyPageå®‰å…¨ä¸éšç§"]
        Notification["MessageNotificationPageæ¶ˆæ¯é€šçŸ¥"]
        Accessibility["AccessibilityPageæ— éšœç¢"]
        CommonSetting["CommonSettingPageé€šç”¨è®¾ç½®"]
    end
    
    subgraph SubPages["å­é¡µé¢"]
        ChangePassword["ChangePasswordPageä¿®æ”¹å¯†ç "]
        DestroyAccount["DestroyAccountPageæ³¨é”€è´¦å·"]
        Language["LanguageSettingPageè¯­è¨€è®¾ç½®"]
        Translation["TranslationSettingPageç¿»è¯‘è®¾ç½®"]
        WebClient["WebClientPageç½‘é¡µç«¯"]
        AutoReply["AutoReplySettingPageè‡ªåŠ¨å›å¤"]
    end
    
    subgraph Logic["ä¸šåŠ¡é€»è¾‘å±‚"]
        MyInfoLogic["MyInfoLogic"]
        SettingManager["MySettingManager"]
    end
    
    subgraph Data["æ•°æ®å±‚"]
        HTTP["HTTP API"]
        Cache["CacheHelper"]
    end
    
    MyPage --> MyInfo
    MyPage --> Security
    MyPage --> Notification
    MyPage --> Accessibility
    MyPage --> CommonSetting
    
    Security --> ChangePassword
    Security --> DestroyAccount
    CommonSetting --> Language
    CommonSetting --> Translation
    
    MyInfo --> MyInfoLogic
    MyInfoLogic --> HTTP
    MyInfoLogic --> Cache
    CommonSetting --> SettingManager
                </div>
                
                <div class="architecture-grid">
                    <div class="arch-item">
                        <h4>ğŸ‘¤ æˆ‘çš„é¦–é¡µ</h4>
                        <p>MyPage å±•ç¤ºç”¨æˆ·å¤´åƒã€æ˜µç§°ï¼Œæä¾›ä¸ªäººèµ„æ–™ã€å®‰å…¨éšç§ã€é€šçŸ¥ã€é€šç”¨è®¾ç½®å…¥å£</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ“ ä¸ªäººèµ„æ–™</h4>
                        <p>MyInfoPage æ”¯æŒä¿®æ”¹å¤´åƒã€æ˜µç§°ã€ç­¾åã€æ€§åˆ«ã€çŸ­å·ã€é‚®ç®±ã€æ‰‹æœºå·ç­‰</p>
                    </div>
                    <div class="arch-item">
                        <h4>ğŸ”’ å®‰å…¨ä¸éšç§</h4>
                        <p>SecurityPrivacyPage åŒ…å«ç”¨æˆ·åè®®ã€éšç§æ”¿ç­–ã€ä¿®æ”¹å¯†ç ã€æ³¨é”€è´¦å·</p>
                    </div>
                    <div class="arch-item">
                        <h4>âš™ï¸ é€šç”¨è®¾ç½®</h4>
                        <p>CommonSettingPage åŒ…å«ç¼“å­˜æ¸…ç†ã€å­—ä½“è®¾ç½®ã€è¯­è¨€ã€ç¿»è¯‘ã€é€€å‡ºç™»å½•ç­‰</p>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ“</div>
                    <h2>ä¸ªäººèµ„æ–™åŠ è½½æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["MyPage.initState"])
    
    Start --> A["Get.put MyInfoLogic"]
    A --> B["MyInfoLogic.onReady"]
    
    subgraph LogicInit["MyInfoLogicåˆå§‹åŒ–"]
        L1["data.value = CacheHelper.userProfile"]
        L2["refreshData"]
    end
    
    B --> L1 --> L2
    
    L2 --> LoadData["loadData"]
    
    subgraph DataLoad["æ•°æ®åŠ è½½"]
        DL1["HttpUtils.syncUserLoginInfo"]
        DL2["HttpUtils.getInviteCode"]
        DL3["CacheHelper.saveInviteInfo"]
        DL4["return CacheHelper.userProfile"]
    end
    
    LoadData --> DL1 --> DL2 --> DL3 --> DL4
    
    DL4 --> UIUpdate["æ›´æ–°UI data.value"]
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green">âœï¸</div>
                    <h2>ä¸ªäººèµ„æ–™ä¿®æ”¹æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant User as User
    participant Page as MyInfoPage
    participant Logic as MyInfoLogic
    participant Dialog as DialogUtils
    participant HTTP as HttpUtils
    participant Server as Server
    participant Cache as CacheHelper
    participant WKIM as WKIM_SDK
    
    User->>Page: ç‚¹å‡»ä¿®æ”¹é¡¹ï¼ˆå¦‚æ˜µç§°ï¼‰
    Page->>Logic: reName/modifySignatureç­‰
    Logic->>Dialog: showInputDialog
    Dialog-->>User: æ˜¾ç¤ºè¾“å…¥æ¡†
    User->>Dialog: è¾“å…¥æ–°å€¼å¹¶ç¡®è®¤
    Dialog-->>Logic: è¿”å›è¾“å…¥ç»“æœ
    
    Logic->>HTTP: updateInfo(key, value)
    HTTP->>Server: æäº¤ä¿®æ”¹è¯·æ±‚
    Server-->>HTTP: è¿”å›æˆåŠŸå“åº”
    
    Logic->>Cache: saveUserProfile(newInfo)
    Logic->>Logic: data.value = newInfo
    Logic->>HTTP: getChannelåˆ·æ–°é¢‘é“
    HTTP->>WKIM: æ›´æ–°æœ¬åœ°é¢‘é“ä¿¡æ¯
    Logic->>Page: æ˜¾ç¤ºä¿®æ”¹æˆåŠŸ
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-orange">ğŸ“·</div>
                    <h2>å¤´åƒä¸Šä¼ æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["é€‰æ‹©å›¾ç‰‡"])
    
    Start --> Pick["ImagePickeré€‰æ‹©å›¾ç‰‡"]
    Pick --> Crop["ImageUtils.cropImageè£å‰ª"]
    Crop --> Compress["ImageUtils.compressFileå‹ç¼©"]
    Compress --> Upload["uploadPhotoä¸Šä¼ "]
    
    subgraph UploadProcess["ä¸Šä¼ æµç¨‹"]
        U1["HttpUtils.uploadAvatar"]
        U2{"ä¸Šä¼ æˆåŠŸ?"}
        U3["clearMyAvatarCacheæ¸…é™¤ç¼“å­˜"]
        U4["æ›´æ–°data.value"]
        U5["getChannelåˆ·æ–°é¢‘é“"]
        U6["æ˜¾ç¤ºä¿®æ”¹æˆåŠŸ"]
        U7["æ˜¾ç¤ºä¿®æ”¹å¤±è´¥"]
    end
    
    Upload --> U1 --> U2
    U2 -->|æ˜¯| U3 --> U4 --> U5 --> U6
    U2 -->|å¦| U7
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸšª</div>
                    <h2>é€€å‡ºç™»å½•æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["ç‚¹å‡»é€€å‡ºç™»å½•"])
    
    Start --> Confirm["_confirmLogoutæ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†"]
    Confirm --> Choice{"ç”¨æˆ·é€‰æ‹©"}
    
    Choice -->|å–æ¶ˆ| Cancel["å…³é—­å¯¹è¯æ¡†"]
    Choice -->|ç¡®è®¤| Logout["CommonHelper.exitLogin"]
    
    subgraph LogoutProcess["é€€å‡ºç™»å½•æµç¨‹"]
        L1["æ–­å¼€IMè¿æ¥"]
        L2["æ¸…é™¤æœ¬åœ°ç¼“å­˜"]
        L3["æ¸…é™¤ç”¨æˆ·æ•°æ®"]
        L4["è·³è½¬åˆ°ç™»å½•é¡µ"]
    end
    
    Logout --> L1 --> L2 --> L3 --> L4
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-cyan">âš™ï¸</div>
                    <h2>é€šç”¨è®¾ç½®åŠŸèƒ½</h2>
                </div>
                
                <div class="flow-description">
                    <h4>CommonSettingPage åŠŸèƒ½åˆ—è¡¨</h4>
                    <ul>
                        <li><strong>æ¸…é™¤ç¼“å­˜</strong> - æ¸…ç†å›¾ç‰‡ç¼“å­˜ã€ä¸‹è½½æ–‡ä»¶ã€è§†é¢‘ç¼“å­˜ã€æ—¥å¿—æ–‡ä»¶</li>
                        <li><strong>å­—ä½“è®¾ç½®</strong> - å…³æ€€æ¨¡å¼ï¼Œè°ƒæ•´åº”ç”¨å­—ä½“å¤§å°</li>
                        <li><strong>å¤šè¯­è¨€</strong> - åˆ‡æ¢åº”ç”¨æ˜¾ç¤ºè¯­è¨€</li>
                        <li><strong>ç¿»è¯‘è®¾ç½®</strong> - é…ç½®æ¶ˆæ¯ç¿»è¯‘ç›®æ ‡è¯­è¨€</li>
                        <li><strong>åŒå‡»æ¶ˆæ¯è¡Œä¸º</strong> - è®¾ç½®åŒå‡»æ¶ˆæ¯çš„æ“ä½œï¼ˆå¤åˆ¶/ç¿»è¯‘ç­‰ï¼‰</li>
                        <li><strong>å…¨å±€èŠå¤©èƒŒæ™¯</strong> - è®¾ç½®æ‰€æœ‰èŠå¤©é¡µé¢çš„é»˜è®¤èƒŒæ™¯</li>
                        <li><strong>å‘é€æŒ‰é’®æ¢è¡Œ</strong> - å°†å‘é€æŒ‰é’®æ›¿æ¢ä¸ºæ¢è¡ŒæŒ‰é’®</li>
                        <li><strong>éšç§æœç´¢è®¾ç½®</strong> - æ§åˆ¶æ˜¯å¦å…è®¸é€šè¿‡æ‰‹æœºå·/çŸ­å·æœç´¢</li>
                        <li><strong>ç‰ˆæœ¬ä¿¡æ¯</strong> - æ˜¾ç¤ºå½“å‰ç‰ˆæœ¬ï¼Œç‚¹å‡»æ£€æŸ¥æ›´æ–°</li>
                        <li><strong>é€€å‡ºç™»å½•</strong> - é€€å‡ºå½“å‰è´¦å·</li>
                    </ul>
                </div>
            </div>
        </section>
        
        <!-- è¿æ¥ç®¡ç† -->
        <section id="connection" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-cyan">ğŸ”Œ</div>
                    <h2>Socket è¿æ¥çŠ¶æ€æœº</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(("å¼€å§‹")) --> Connecting["Connectingè¿æ¥ä¸­"]
    Connecting --> Success["Successè¿æ¥æˆåŠŸ"]
    Connecting --> Fail["Failè¿æ¥å¤±è´¥"]
    Connecting --> NoNetwork["NoNetworkæ— ç½‘ç»œ"]
    
    Success --> SyncMsg["SyncMsgåŒæ­¥æ¶ˆæ¯ä¸­"]
    SyncMsg --> SyncCompleted["SyncCompletedåŒæ­¥å®Œæˆ"]
    
    Success -.-> Fail
    SyncMsg -.-> Fail
    SyncCompleted -.-> Fail
    
    Fail --> Connecting
    NoNetwork --> Connecting
    
    SyncCompleted --> Kicked["Kickedè¢«è¸¢å‡º"]
    Kicked --> End(("ç»“æŸ"))
                </div>
                
                <div class="flow-description">
                    <h4>è¿æ¥çŠ¶æ€è¯´æ˜</h4>
                    <ul>
                        <li><strong>connecting</strong> - è¿æ¥ä¸­ï¼Œæ˜¾ç¤º"è¿æ¥ä¸­..."</li>
                        <li><strong>success</strong> - è¿æ¥æˆåŠŸ</li>
                        <li><strong>syncMsg</strong> - åŒæ­¥æ¶ˆæ¯ä¸­ï¼Œæ˜¾ç¤º"åŒæ­¥æ¶ˆæ¯ä¸­..."</li>
                        <li><strong>syncCompleted</strong> - åŒæ­¥å®Œæˆï¼Œéšè—çŠ¶æ€</li>
                        <li><strong>fail</strong> - è¿æ¥å¤±è´¥</li>
                        <li><strong>noNetwork</strong> - æ— ç½‘ç»œ</li>
                        <li><strong>kicked</strong> - è¢«è¸¢å‡ºï¼Œè·³è½¬ç™»å½•é¡µ</li>
                    </ul>
                </div>
                
                <h3>è¿æ¥è§¦å‘æ—¶æœº</h3>
                <div class="mermaid">
flowchart TD
    subgraph Triggers["è¿æ¥è§¦å‘æ—¶æœº"]
        T1["1.åº”ç”¨å¯åŠ¨å·²ç™»å½•"]
        T2["2.ç™»å½•æˆåŠŸ"]
        T3["3.Appæ¢å¤å‰å°"]
        T4["4.ç½‘ç»œæ¢å¤"]
        T5["5.ç½‘ç»œç±»å‹åˆ‡æ¢WiFiâ†”ç§»åŠ¨"]
    end
    
    T1 --> Connect["connectionManager.connect"]
    T2 --> Connect
    T3 --> Check{"æ£€æŸ¥è¿æ¥çŠ¶æ€"}
    T4 --> Check
    T5 --> Reconnect["æ–­å¼€åé‡è¿"]
    Check -->|æ–­å¼€| Connect
    Check -->|æ­£å¸¸| Keep["ä¿æŒè¿æ¥"]
    Reconnect --> Connect
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green">ğŸ”—</div>
                    <h2>Socket è¿æ¥å»ºç«‹æµç¨‹</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant App as App
    participant CM as ConnectionManager
    participant Socket as _WKSocket
    participant Server as IMæœåŠ¡å™¨
    
    Note over App,Server: 1. è¿æ¥å‰æ£€æŸ¥
    App->>CM: connect()
    CM->>CM: æ£€æŸ¥_isConnectingé”
    CM->>CM: æ£€æŸ¥uid/tokenæ˜¯å¦å­˜åœ¨
    CM->>CM: æ£€æŸ¥ç½‘ç»œæ˜¯å¦å¯ç”¨
    CM->>CM: æ£€æŸ¥æ˜¯å¦å·²åœ¨è¿æ¥ä¸­
    
    Note over App,Server: 2. è·å–æœåŠ¡å™¨åœ°å€
    alt æœ‰ç¼“å­˜åœ°å€
        CM->>CM: ä½¿ç”¨ç¼“å­˜åœ°å€
    else æ— ç¼“å­˜åœ°å€
        CM->>App: getAddrå›è°ƒè·å–åœ°å€
        App-->>CM: è¿”å›æœåŠ¡å™¨åœ°å€
        CM->>CM: ç¼“å­˜æœåŠ¡å™¨åœ°å€
    end
    
    Note over App,Server: 3. å»ºç«‹TCPè¿æ¥
    CM->>CM: setStatus(CONNECTING)
    CM->>Socket: Socket.connect(host, port, timeout: 5s)
    Socket->>Server: TCPä¸‰æ¬¡æ¡æ‰‹
    Server-->>Socket: è¿æ¥å»ºç«‹
    Socket-->>CM: thenå›è°ƒ
    CM->>Socket: setOption(tcpNoDelay)
    CM->>CM: åˆ›å»º_WKSocketåŒ…è£…å™¨
    
    Note over App,Server: 4. å‘é€è¿æ¥åŒ…
    CM->>CM: _sendConnectPacket()
    CM->>CM: ç”ŸæˆDHå…¬é’¥
    CM->>CM: è·å–è®¾å¤‡ID
    CM->>Socket: å‘é€ConnectPacket
    Socket->>Server: uid/token/deviceID/clientKey
    
    Note over App,Server: 5. ç­‰å¾…è¿æ¥ç¡®è®¤
    Server-->>Socket: ConnackPacket
    Socket-->>CM: è§£æConnackPacket
    
    alt reasonCode == 1 æˆåŠŸ
        CM->>CM: ä¿å­˜serverKey/salt
        CM->>CM: setStatus(SUCCESS)
        CM->>CM: å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨
        CM->>CM: å¯åŠ¨ç½‘ç»œæ£€æŸ¥å®šæ—¶å™¨
        CM->>CM: è§¦å‘ä¼šè¯åŒæ­¥
    else reasonCode != 1 å¤±è´¥
        CM->>CM: setStatus(FAIL)
        CM->>CM: è§¦å‘é‡è¿
    end
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-orange">âŒ</div>
                    <h2>Socket æ–­å¼€è¿æ¥æµç¨‹</h2>
                </div>
                
                <h3>1. å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€</h3>
                <div class="mermaid">
flowchart TD
    Start(["disconnect(isLogout)"])
    
    Start --> A["é‡ç½®_isConnectingé”"]
    A --> B["å–æ¶ˆé‡è¿å®šæ—¶å™¨"]
    B --> C["æ ‡è®°_isIntentionalClose=true"]
    C --> D["å…³é—­Socketè¿æ¥"]
    D --> E["æ¸…ç†pendingè¯·æ±‚"]
    
    E --> F{"isLogout?"}
    F -->|æ˜¯| G["æ¸…é™¤uid/token"]
    G --> H["æ›´æ–°å‘é€ä¸­æ¶ˆæ¯ä¸ºå¤±è´¥"]
    H --> I["å…³é—­æ•°æ®åº“"]
    I --> J["æ¸…ç†é‡å‘é˜Ÿåˆ—"]
    J --> K["æ¸…ç†é¢‘é“ç¼“å­˜"]
    K --> L["é‡ç½®æ—¥å¿—çŠ¶æ€"]
    L --> M["_closeAllå…³é—­æ‰€æœ‰"]
    
    F -->|å¦| N["ä¿ç•™ç™»å½•çŠ¶æ€"]
    N --> O["ç­‰å¾…é‡è¿"]
                </div>
                
                <h3>2. æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€</h3>
                <div class="mermaid">
flowchart TD
    subgraph ServerClose["æœåŠ¡å™¨æ–­å¼€è¿æ¥"]
        S1["æ”¶åˆ°FINåŒ…"]
        S2["onDoneå›è°ƒè§¦å‘"]
        S3["è®°å½•æ–­å¼€åŸå› æ—¥å¿—"]
        S4["å…³é—­Socket"]
        S5["setStatus(FAIL)"]
        S6["è§¦å‘è‡ªåŠ¨é‡è¿"]
    end
    
    S1 --> S2 --> S3 --> S4 --> S5 --> S6
    
    subgraph Reasons["å¯èƒ½çš„æ–­å¼€åŸå› "]
        R1["å¿ƒè·³è¶…æ—¶"]
        R2["æœåŠ¡å™¨é‡å¯"]
        R3["è¢«å…¶ä»–è®¾å¤‡è¸¢ä¸‹çº¿"]
        R4["æœåŠ¡å™¨ä¸»åŠ¨æ–­å¼€"]
    end
                </div>
                
                <h3>3. ç½‘ç»œå¼‚å¸¸æ–­å¼€</h3>
                <div class="mermaid">
flowchart TD
    subgraph NetworkError["ç½‘ç»œå¼‚å¸¸æ–­å¼€"]
        N1["Socket onErrorè§¦å‘"]
        N2["è®°å½•é”™è¯¯ç±»å‹å’Œè¯¦æƒ…"]
        N3["å…³é—­Socket"]
        N4["setStatus(FAIL)"]
        N5["å»¶è¿Ÿåè‡ªåŠ¨é‡è¿"]
    end
    
    N1 --> N2 --> N3 --> N4 --> N5
                </div>
                
                <h3>4. è¢«è¸¢ä¸‹çº¿æµç¨‹</h3>
                <div class="mermaid">
flowchart TD
    Start(["æ”¶åˆ°DisconnectPacket"])
    
    Start --> A["disconnect(isLogout=true)"]
    A --> B["setStatus(KICKED)"]
    B --> C["UIç›‘å¬åˆ°KICKEDçŠ¶æ€"]
    C --> D["ä¸ŠæŠ¥è¢«è¸¢äº‹ä»¶"]
    D --> E["CommonHelper.exitLogin()"]
    E --> F["è·³è½¬åˆ°ç™»å½•é¡µ"]
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ”„</div>
                    <h2>è‡ªåŠ¨é‡è¿æœºåˆ¶</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["è¿æ¥å¤±è´¥/æ–­å¼€"])
    
    Start --> A{"ç½‘ç»œæ˜¯å¦å¯ç”¨?"}
    A -->|å¦| B["setStatus(NO_NETWORK)"]
    B --> C["ç­‰å¾…ç½‘ç»œæ¢å¤"]
    C --> D["ç½‘ç»œæ¢å¤äº‹ä»¶"]
    D --> E["é‡ç½®é‡è¿å‚æ•°"]
    E --> F["è§¦å‘é‡è¿"]
    
    A -->|æ˜¯| G["setStatus(FAIL)"]
    G --> H["è®¡ç®—é‡è¿å»¶è¿ŸæŒ‡æ•°é€€é¿"]
    H --> I["è®¾ç½®é‡è¿å®šæ—¶å™¨"]
    I --> J["å»¶è¿Ÿåæ£€æŸ¥æ¡ä»¶"]
    
    J --> K{"isLogin?"}
    K -->|å¦| L["ä¸é‡è¿"]
    K -->|æ˜¯| M{"isConnectDisabled?"}
    M -->|å¦| N["è¿æ¥æ­£å¸¸,è·³è¿‡"]
    M -->|æ˜¯| O["resumeConnect()"]
    O --> P["disconnect(false)"]
    P --> Q["connect()"]
                </div>
                
                <h3>æŒ‡æ•°é€€é¿ç®—æ³•</h3>
                <div class="mermaid">
flowchart LR
    subgraph Backoff["é‡è¿é—´éš”è®¡ç®—"]
        B1["åŸºç¡€é—´éš”: 1500ms"]
        B2["ç¬¬1æ¬¡: 1500ms"]
        B3["ç¬¬2æ¬¡: 3000ms"]
        B4["ç¬¬3æ¬¡: 6000ms"]
        B5["ç¬¬4æ¬¡: 12000ms"]
        B6["ç¬¬5æ¬¡: 24000ms"]
        B7["ç¬¬6æ¬¡+: 30000msæœ€å¤§å€¼"]
    end
    
    B1 --> B2 --> B3 --> B4 --> B5 --> B6 --> B7
    
    subgraph Formula["è®¡ç®—å…¬å¼"]
        F1["delay = base Ã— 2^(attempts-1)"]
        F2["clamp(1500, 30000)"]
    end
                </div>
                
                <h3>åå°é‡è¿é€€é¿æœºåˆ¶</h3>
                <div class="mermaid">
flowchart TD
    subgraph BackgroundReconnect["åå°é‡è¿é™åˆ¶"]
        BG1["æœ€å¤§é‡è¿æ¬¡æ•°: 5æ¬¡"]
        BG2["å†·å´æ—¶é—´: 30ç§’"]
        BG3["è¶…è¿‡é™åˆ¶åç­‰å¾…HeartbeatService"]
    end
    
    Start(["åå°æ£€æµ‹åˆ°æ–­å¼€"])
    Start --> A{"é‡è¿æ¬¡æ•° < 5?"}
    A -->|æ˜¯| B["_backgroundReconnectAttempts++"]
    B --> C["è®°å½•é‡è¿æ—¶é—´"]
    C --> D["æ‰§è¡Œé‡è¿"]
    
    A -->|å¦| E{"å†·å´æ—¶é—´å·²è¿‡?"}
    E -->|æ˜¯| F["é‡ç½®è®¡æ•°å™¨"]
    F --> B
    E -->|å¦| G["ç­‰å¾…HeartbeatServiceè§¦å‘"]
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ’“</div>
                    <h2>å¿ƒè·³ä¿æ´»æœºåˆ¶</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant CM as ConnectionManager
    participant Timer as HeartTimer
    participant Socket as _WKSocket
    participant Server as IMæœåŠ¡å™¨
    
    Note over CM,Server: è¿æ¥æˆåŠŸåå¯åŠ¨å¿ƒè·³
    CM->>CM: _startHeartTimer()
    CM->>CM: ç«‹å³å‘é€é¦–æ¬¡å¿ƒè·³
    CM->>Socket: PingPacket
    Socket->>Server: PING
    Server-->>Socket: PONG
    
    loop æ¯30ç§’
        Timer->>CM: å®šæ—¶å™¨è§¦å‘
        CM->>CM: æ£€æŸ¥isConnectionAlive
        
        alt è¿æ¥æ­£å¸¸
            CM->>CM: æ£€æŸ¥ç½‘ç»œçŠ¶æ€
            alt ç½‘ç»œå¯ç”¨
                CM->>Socket: PingPacket
                Socket->>Server: PING
                Server-->>Socket: PONG
                Note right of Server: æœåŠ¡å™¨è¶…æ—¶1åˆ†é’Ÿ
            else ç½‘ç»œä¸å¯ç”¨
                CM->>CM: setStatus(NO_NETWORK)
            end
        else è¿æ¥ä¸å¯ç”¨
            CM->>CM: è·³è¿‡å¿ƒè·³å‘é€
        end
    end
    
    Note over CM,Server: æ–­å¼€æ—¶åœæ­¢å¿ƒè·³
    CM->>Timer: _stopHeartTimer()
                </div>
                
                <div class="flow-description">
                    <h4>å¿ƒè·³æœºåˆ¶è¯´æ˜</h4>
                    <ul>
                        <li><strong>å¿ƒè·³é—´éš”</strong> - 30ç§’å‘é€ä¸€æ¬¡PINGåŒ…</li>
                        <li><strong>æœåŠ¡å™¨è¶…æ—¶</strong> - 1åˆ†é’Ÿæœªæ”¶åˆ°å¿ƒè·³åˆ™æ–­å¼€è¿æ¥</li>
                        <li><strong>é¦–æ¬¡å¿ƒè·³</strong> - è¿æ¥æˆåŠŸåç«‹å³å‘é€ï¼Œé¿å…æœåŠ¡å™¨æå‰æ–­å¼€</li>
                        <li><strong>ç½‘ç»œæ£€æŸ¥</strong> - å‘é€å‰æ£€æŸ¥ç½‘ç»œçŠ¶æ€ï¼Œæ— ç½‘ç»œæ—¶ä¸å‘é€</li>
                        <li><strong>è¿æ¥æ£€æŸ¥</strong> - å‘é€å‰æ£€æŸ¥Socketæ˜¯å¦å¯ç”¨</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-pink">ğŸ“¡</div>
                    <h2>ç½‘ç»œçŠ¶æ€ç›‘å¬</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    Start(["ç½‘ç»œçŠ¶æ€å˜åŒ–"])
    
    Start --> A["_parseConnectivityResults"]
    A --> B["å»æŠ–åŠ¨å»¶è¿Ÿ500ms"]
    B --> C["_handleNetworkChange"]
    
    C --> D{"ç½‘ç»œç±»å‹"}
    
    D -->|WiFi| E["currentNetworkType = wifi"]
    D -->|ç§»åŠ¨ç½‘ç»œ| F["currentNetworkType = mobile"]
    D -->|æ— ç½‘ç»œ| G["currentNetworkType = none"]
    
    E --> H{"ç½‘ç»œç±»å‹åˆ‡æ¢?"}
    F --> H
    
    H -->|æ˜¯WiFiâ†”ç§»åŠ¨| I["æ–­å¼€å½“å‰è¿æ¥"]
    I --> J["é‡ç½®é‡è¿å‚æ•°"]
    J --> K["å»¶è¿Ÿ500ms"]
    K --> L["é‡æ–°è¿æ¥"]
    
    H -->|å¦ä»æ— ç½‘ç»œæ¢å¤| M["é‡ç½®é‡è¿å‚æ•°"]
    M --> N["ç«‹å³è¿æ¥"]
    
    H -->|å¦ç½‘ç»œå¯ç”¨ä½†æ–­å¼€| O["é‡ç½®é‡è¿å‚æ•°"]
    O --> P["ç«‹å³è¿æ¥"]
    
    G --> Q["æ–­å¼€è¿æ¥"]
    Q --> R["setStatus(NO_NETWORK)"]
                </div>
                
                <h3>å®šæ—¶ç½‘ç»œæ£€æŸ¥</h3>
                <div class="mermaid">
flowchart TD
    Start(["æ¯3ç§’æ£€æŸ¥"])
    
    Start --> A{"ç½‘ç»œçŠ¶æ€"}
    
    A -->|æ— ç½‘ç»œ| B["setStatus(NO_NETWORK)"]
    B --> C["æ–­å¼€è¿æ¥"]
    C --> D["æ£€æŸ¥å¾…é‡å‘æ¶ˆæ¯"]
    
    A -->|æœ‰ç½‘ç»œ| E{"è¿æ¥æ˜¯å¦æ­£å¸¸?"}
    E -->|æ˜¯| F["æ£€æŸ¥å¾…é‡å‘æ¶ˆæ¯"]
    
    E -->|å¦| G{"æ­£åœ¨è¿æ¥ä¸­?"}
    G -->|æ˜¯| H["è·³è¿‡"]
    
    G -->|å¦| I{"å‰å°/åå°?"}
    I -->|å‰å°| J["é‡ç½®é€€é¿è®¡æ•°"]
    J --> K["ç«‹å³é‡è¿"]
    
    I -->|åå°| L{"é€€é¿é™åˆ¶å†…?"}
    L -->|æ˜¯| M["å¢åŠ é‡è¿è®¡æ•°"]
    M --> N["æ‰§è¡Œé‡è¿"]
    L -->|å¦| O["ç­‰å¾…HeartbeatService"]
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-cyan">ğŸ </div>
                    <h2>åå°ä¿æ´»æœºåˆ¶</h2>
                </div>
                
                <div class="mermaid">
sequenceDiagram
    participant App as App
    participant BG as BackgroundTask
    participant Heart as HeartbeatService
    participant CM as ConnectionManager
    participant Server as Server
    
    App->>App: è¿›å…¥åå°paused
    App->>BG: handleAppLifecycleChange(false)
    BG->>Heart: startHeartbeatService
    
    loop åŸç”Ÿå®šæ—¶å¿ƒè·³
        Heart->>Heart: sendHeartbeat
        
        alt è¿æ¥æ­£å¸¸
            Heart->>CM: sendPing()
            CM->>Server: å‘é€å¿ƒè·³åŒ…
            Server-->>CM: PONGå“åº”
            Note right of Heart: ä¿æŒè¿æ¥æ´»è·ƒ
        else è¿æ¥æ–­å¼€
            Heart->>CM: resumeConnect()
            CM->>Server: é‡æ–°å»ºç«‹è¿æ¥
        end
    end
    
    App->>App: æ¢å¤å‰å°resumed
    App->>BG: handleAppLifecycleChange(true)
    BG->>Heart: stopHeartbeatService
    BG->>CM: é‡ç½®åå°é‡è¿é€€é¿
    BG->>CM: æ£€æŸ¥è¿æ¥çŠ¶æ€
    
    alt è¿æ¥æ–­å¼€
        BG->>CM: resumeConnect()
    end
                </div>
                
                <div class="flow-description">
                    <h4>åå°ä¿æ´»è¯´æ˜</h4>
                    <ul>
                        <li><strong>åŸç”ŸæœåŠ¡</strong> - Flutterå®šæ—¶å™¨åœ¨åå°å¯èƒ½è¢«æš‚åœï¼Œä½¿ç”¨åŸç”ŸHeartbeatService</li>
                        <li><strong>å®šæ—¶å¿ƒè·³</strong> - åŸç”ŸæœåŠ¡å®šæœŸè§¦å‘Flutterå±‚å‘é€å¿ƒè·³</li>
                        <li><strong>æ–­çº¿æ£€æµ‹</strong> - å¿ƒè·³å¤±è´¥æ—¶è§¦å‘é‡è¿</li>
                        <li><strong>å‰å°æ¢å¤</strong> - æ¢å¤å‰å°æ—¶åœæ­¢åŸç”ŸæœåŠ¡ï¼Œæ£€æŸ¥å¹¶æ¢å¤è¿æ¥</li>
                        <li><strong>é€€é¿é‡ç½®</strong> - å‰å°æ¢å¤æ—¶é‡ç½®åå°é‡è¿é€€é¿è®¡æ•°</li>
                    </ul>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-orange">ğŸ‘€</div>
                    <h2>è¿æ¥çŠ¶æ€ç›‘å¬ä¸UIæ›´æ–°</h2>
                </div>
                
                <div class="mermaid">
flowchart TD
    subgraph SDK["WKIM SDK"]
        CM["ConnectionManager"]
        Status["setConnectionStatus"]
        Listeners["_connectionListenerMap"]
    end
    
    subgraph App["åº”ç”¨å±‚ç›‘å¬"]
        HL["HomeConversationLogic"]
        CL["ChatLogic"]
        Widget["ConnectStatusWidget"]
    end
    
    CM --> Status
    Status --> Listeners
    Listeners --> HL
    Listeners --> CL
    
    HL --> HUI["ä¼šè¯åˆ—è¡¨çŠ¶æ€æ "]
    CL --> CUI["èŠå¤©é¡µçŠ¶æ€æ "]
    
    subgraph UILogic["UIæ˜¾ç¤ºé€»è¾‘"]
        U1["CONNECTING â†’ æ˜¾ç¤ºè¿æ¥ä¸­..."]
        U2["SYNC_MSG â†’ æ˜¾ç¤ºåŒæ­¥æ¶ˆæ¯ä¸­..."]
        U3["SUCCESS/SYNC_COMPLETED â†’ éšè—çŠ¶æ€æ "]
        U4["FAIL â†’ å»¶è¿Ÿ15ç§’åæ˜¾ç¤º"]
        U5["NO_NETWORK â†’ å»¶è¿Ÿ3ç§’åæ˜¾ç¤º"]
        U6["KICKED â†’ é€€å‡ºç™»å½•"]
    end
    
    HUI --> Widget
    CUI --> Widget
    Widget --> UILogic
                </div>
                
                <h3>ConnectStatusWidget æ˜¾ç¤ºé€»è¾‘</h3>
                <div class="mermaid">
flowchart TD
    Start(["çŠ¶æ€å˜åŒ–"])
    
    Start --> A{"çŠ¶æ€ç±»å‹"}
    
    A -->|SUCCESS/SYNC| B["é‡ç½®å¤±è´¥æ—¶é—´"]
    B --> C["éšè—æ¨ªæ¡"]
    
    A -->|CONNECTING| D["éšè—æ¨ªæ¡é™é»˜é‡è¿"]
    
    A -->|NO_NETWORK| E["å»¶è¿Ÿ3ç§’"]
    E --> F{"ä»æ˜¯NO_NETWORK?"}
    F -->|æ˜¯| G["æ˜¾ç¤ºæ¨ªæ¡"]
    F -->|å¦| H["ä¸æ˜¾ç¤º"]
    
    A -->|FAIL| I["è®°å½•é¦–æ¬¡å¤±è´¥æ—¶é—´"]
    I --> J{"å¤±è´¥è¶…è¿‡15ç§’?"}
    J -->|æ˜¯| K["æ˜¾ç¤ºæ¨ªæ¡"]
    J -->|å¦| L["è®¾ç½®å®šæ—¶å™¨"]
    L --> M["ç­‰å¾…å‰©ä½™æ—¶é—´"]
    M --> N{"ä»æ˜¯FAIL?"}
    N -->|æ˜¯| K
    N -->|å¦| H
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ“¦</div>
                    <h2>Socket æ•°æ®åŒ…å¤„ç†</h2>
                </div>
                
                <h3>æ•°æ®åŒ…ç±»å‹</h3>
                <div class="mermaid">
flowchart LR
    subgraph SendPackets["å‘é€çš„æ•°æ®åŒ…"]
        S1["ConnectPacket è¿æ¥åŒ…"]
        S2["PingPacket å¿ƒè·³åŒ…"]
        S3["SendPacket å‘é€æ¶ˆæ¯"]
        S4["RecvAckPacket æ¥æ”¶ç¡®è®¤"]
        S5["RequestPacket è¯·æ±‚åŒ…"]
    end
    
    subgraph RecvPackets["æ¥æ”¶çš„æ•°æ®åŒ…"]
        R1["ConnackPacket è¿æ¥ç¡®è®¤"]
        R2["PongPacket å¿ƒè·³å“åº”"]
        R3["RecvPacket æ¥æ”¶æ¶ˆæ¯"]
        R4["SendAckPacket å‘é€ç¡®è®¤"]
        R5["DisconnectPacket æ–­å¼€é€šçŸ¥"]
        R6["ResponsePacket å“åº”åŒ…"]
    end
                </div>
                
                <h3>æ•°æ®åŒ…è§£ææµç¨‹</h3>
                <div class="mermaid">
flowchart TD
    Start(["æ”¶åˆ°Socketæ•°æ®"])
    
    Start --> A["_cutDataså¤„ç†ç²˜åŒ…/åŠåŒ…"]
    A --> B{"æ•°æ®æ˜¯å¦å®Œæ•´?"}
    
    B -->|å¦| C["ç¼“å­˜åˆ°_cacheData"]
    C --> D["ç­‰å¾…æ›´å¤šæ•°æ®"]
    
    B -->|æ˜¯| E["æå–å®Œæ•´æ•°æ®åŒ…"]
    E --> F["_decodePacketè§£ç "]
    
    F --> G{"æ•°æ®åŒ…ç±»å‹"}
    
    G -->|CONNACK| H["å¤„ç†è¿æ¥ç¡®è®¤"]
    H --> H1{"reasonCode==1?"}
    H1 -->|æ˜¯| H2["è¿æ¥æˆåŠŸ"]
    H1 -->|å¦| H3["è¿æ¥å¤±è´¥"]
    
    G -->|RECV| I["å¤„ç†æ¥æ”¶æ¶ˆæ¯"]
    I --> I1["åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—"]
    I1 --> I2["éªŒè¯æ¶ˆæ¯"]
    I2 --> I3["ä¿å­˜åˆ°æ•°æ®åº“"]
    I3 --> I4["å‘é€RecvAck"]
    
    G -->|SENDACK| J["å¤„ç†å‘é€ç¡®è®¤"]
    J --> J1["é€šçŸ¥é‡å‘ç®¡ç†å™¨"]
    J1 --> J2["æ›´æ–°æ¶ˆæ¯çŠ¶æ€"]
    
    G -->|PONG| K["è®°å½•å¿ƒè·³å“åº”"]
    
    G -->|DISCONNECT| L["å¤„ç†è¸¢ä¸‹çº¿"]
    L --> L1["disconnect(true)"]
    L1 --> L2["setStatus(KICKED)"]
    
    G -->|RESPONSE| M["å¤„ç†è¯·æ±‚å“åº”"]
    M --> M1["æ‰¾åˆ°å¯¹åº”Completer"]
    M1 --> M2["completeå“åº”"]
                </div>
            </div>
        </section>
        
        <!-- æ–‡ä»¶ç´¢å¼• -->
        <section id="files" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue">ğŸ“</div>
                    <h2>å…³é”®æ–‡ä»¶ç´¢å¼•</h2>
                </div>
                
                <table class="file-table">
                    <thead>
                        <tr>
                            <th>æ¨¡å—</th>
                            <th>æ–‡ä»¶è·¯å¾„</th>
                            <th>è¯´æ˜</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>å…¥å£</td>
                            <td class="file-path">lib/main.dart</td>
                            <td>åº”ç”¨å…¥å£ï¼Œåˆå§‹åŒ–å„ç§æœåŠ¡</td>
                        </tr>
                        <tr>
                            <td>App</td>
                            <td class="file-path">lib/app.dart</td>
                            <td>App Widgetï¼Œç”Ÿå‘½å‘¨æœŸç®¡ç†</td>
                        </tr>
                        <tr>
                            <td>ä¸»é¡µ</td>
                            <td class="file-path">lib/module/main_page.dart</td>
                            <td>è·¯ç”±åˆ¤æ–­ï¼ˆç™»å½•/å®Œå–„ä¿¡æ¯/ä¸»é¡µï¼‰</td>
                        </tr>
                        <tr>
                            <td>Tabé¡µ</td>
                            <td class="file-path">lib/module/main/main_tab_page.dart</td>
                            <td>åº•éƒ¨ Tab é¡µé¢</td>
                        </tr>
                        <tr>
                            <td>ä¼šè¯åˆ—è¡¨</td>
                            <td class="file-path">lib/module/conversation/home_conversation_page.dart</td>
                            <td>ä¼šè¯åˆ—è¡¨ UI</td>
                        </tr>
                        <tr>
                            <td>ä¼šè¯é€»è¾‘</td>
                            <td class="file-path">lib/module/conversation/home_conversation_logic.dart</td>
                            <td>ä¼šè¯åˆ—è¡¨é€»è¾‘</td>
                        </tr>
                        <tr>
                            <td>ä¼šè¯åŸºç±»</td>
                            <td class="file-path">lib/module/conversation/conversation_logic.dart</td>
                            <td>ä¼šè¯æ•°æ®åŠ è½½/ç›‘å¬</td>
                        </tr>
                        <tr>
                            <td>èŠå¤©é¡µ</td>
                            <td class="file-path">lib/module/chat/chat_page.dart</td>
                            <td>èŠå¤©é¡µé¢ UI</td>
                        </tr>
                        <tr>
                            <td>èŠå¤©é€»è¾‘</td>
                            <td class="file-path">lib/module/chat/chat_logic.dart</td>
                            <td>èŠå¤©é¡µæ ¸å¿ƒé€»è¾‘</td>
                        </tr>
                        <tr>
                            <td>æ¶ˆæ¯æ§åˆ¶å™¨</td>
                            <td class="file-path">lib/module/chat/controller/chat_msg_controller.dart</td>
                            <td>æ¶ˆæ¯åŠ è½½æ§åˆ¶</td>
                        </tr>
                        <tr>
                            <td>IM å·¥å…·</td>
                            <td class="file-path">lib/utils/im/im_utils.dart</td>
                            <td>IM åˆå§‹åŒ–/ç›‘å¬å™¨æ³¨å†Œ</td>
                        </tr>
                        <tr>
                            <td>åå°ä»»åŠ¡</td>
                            <td class="file-path">lib/utils/im/background_task.dart</td>
                            <td>åå°å¿ƒè·³/æ¨é€å¤„ç†</td>
                        </tr>
                        <tr>
                            <td>ç¼“å­˜</td>
                            <td class="file-path">lib/cache/cache.dart</td>
                            <td>æœ¬åœ°ç¼“å­˜å°è£…</td>
                        </tr>
                        <tr>
                            <td>ç¼“å­˜åŠ©æ‰‹</td>
                            <td class="file-path">lib/cache/cache_helper.dart</td>
                            <td>ç¼“å­˜ä¾¿æ·æ–¹æ³•</td>
                        </tr>
                        <tr>
                            <td>Tab æœªè¯»</td>
                            <td class="file-path">lib/bloc/navigation/navi_count_bloc.dart</td>
                            <td>åº•éƒ¨ Tab æœªè¯»æ•°ç®¡ç†</td>
                        </tr>
                        <tr>
                            <td>ç‰ˆæœ¬å‡çº§å·¥å…·</td>
                            <td class="file-path">lib/module/appupgrade/app_upgrade_utils.dart</td>
                            <td>ç‰ˆæœ¬æ£€æŸ¥/æ¯”è¾ƒ/å®‰è£…å·¥å…·</td>
                        </tr>
                        <tr>
                            <td>ç‰ˆæœ¬å‡çº§é€»è¾‘</td>
                            <td class="file-path">lib/module/appupgrade/app_upgrade_logic.dart</td>
                            <td>ç‰ˆæœ¬æ›´æ–°ä¸‹è½½/å®‰è£…é€»è¾‘</td>
                        </tr>
                        <tr>
                            <td>å¼ºåˆ¶æ›´æ–°é¡µ</td>
                            <td class="file-path">lib/module/appupgrade/app_upgrade_page.dart</td>
                            <td>å¼ºåˆ¶æ›´æ–°å…¨å±é¡µé¢</td>
                        </tr>
                        <tr>
                            <td>æ›´æ–°å¯¹è¯æ¡†</td>
                            <td class="file-path">lib/module/appupgrade/app_upgrade_dialog.dart</td>
                            <td>éå¼ºåˆ¶æ›´æ–°å¼¹çª—</td>
                        </tr>
                        <tr>
                            <td>ç‰ˆæœ¬æ¨¡å‹</td>
                            <td class="file-path">lib/model/app_version.dart</td>
                            <td>AppVersion æ•°æ®æ¨¡å‹</td>
                        </tr>
                        <tr>
                            <td>è”ç³»äººé¦–é¡µ</td>
                            <td class="file-path">lib/module/contact/home_contact_page.dart</td>
                            <td>è”ç³»äººTabé¦–é¡µUI</td>
                        </tr>
                        <tr>
                            <td>è”ç³»äººåˆ—è¡¨</td>
                            <td class="file-path">lib/module/contact/contact_page.dart</td>
                            <td>è”ç³»äººåˆ—è¡¨UIç»„ä»¶</td>
                        </tr>
                        <tr>
                            <td>è”ç³»äººé€»è¾‘</td>
                            <td class="file-path">lib/module/contact/contact_logic.dart</td>
                            <td>è”ç³»äººæ•°æ®åŠ è½½/åˆ†ç»„/ç›‘å¬</td>
                        </tr>
                        <tr>
                            <td>å¥½å‹ç”³è¯·</td>
                            <td class="file-path">lib/module/contact/apply/friend_apply_list_logic.dart</td>
                            <td>å¥½å‹ç”³è¯·åˆ—è¡¨é€»è¾‘</td>
                        </tr>
                        <tr>
                            <td>æˆ‘çš„ç¾¤ç»„</td>
                            <td class="file-path">lib/module/contact/groups/my_groups_logic.dart</td>
                            <td>ä¿å­˜çš„ç¾¤ç»„åˆ—è¡¨é€»è¾‘</td>
                        </tr>
                        <tr>
                            <td>æˆ‘çš„é¦–é¡µ</td>
                            <td class="file-path">lib/module/my/my_page.dart</td>
                            <td>æˆ‘çš„Tabé¦–é¡µUI</td>
                        </tr>
                        <tr>
                            <td>ä¸ªäººèµ„æ–™é€»è¾‘</td>
                            <td class="file-path">lib/module/user/mine/my_info_logic.dart</td>
                            <td>ä¸ªäººèµ„æ–™ä¿®æ”¹é€»è¾‘</td>
                        </tr>
                        <tr>
                            <td>å®‰å…¨ä¸éšç§</td>
                            <td class="file-path">lib/module/my/securityAndPrivacy/security_privacy_page.dart</td>
                            <td>å®‰å…¨ä¸éšç§è®¾ç½®é¡µ</td>
                        </tr>
                        <tr>
                            <td>é€šç”¨è®¾ç½®</td>
                            <td class="file-path">lib/module/my/commonSetting/common_setting_page.dart</td>
                            <td>é€šç”¨è®¾ç½®é¡µï¼ˆå«é€€å‡ºç™»å½•ï¼‰</td>
                        </tr>
                        <tr>
                            <td>è¿æ¥ç®¡ç†å™¨</td>
                            <td class="file-path">third/wukongimfluttersdk/lib/manager/connect_manager.dart</td>
                            <td>Socketè¿æ¥/æ–­å¼€/é‡è¿/å¿ƒè·³ç®¡ç†</td>
                        </tr>
                        <tr>
                            <td>è¿æ¥çŠ¶æ€ç»„ä»¶</td>
                            <td class="file-path">lib/widget/connect_status_widget.dart</td>
                            <td>è¿æ¥çŠ¶æ€æ¨ªæ¡UIç»„ä»¶</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-purple">ğŸ”—</div>
                    <h2>æ ¸å¿ƒç±»å…³ç³»å›¾</h2>
                </div>
                
                <div class="mermaid">
classDiagram
    class ListController {
        +list
        +loadData()
        +refreshData()
    }
    
    class ConversationLogic {
        +loadData()
        +initListener()
        +updatePin()
        +updateReadStatus()
        +deleteMsg()
    }
    
    class HomeConversationLogic {
        +onReady()
        +initListener()
    }
    
    class HomeConversationPage {
        +logic
        +build()
    }
    
    ListController <|-- ConversationLogic
    ConversationLogic <|-- HomeConversationLogic
    HomeConversationLogic --o HomeConversationPage
    
    class GetxController {
        +onInit()
        +onReady()
        +onClose()
    }
    
    class ChatMsgController {
        +messages
        +startRefresh()
        +loadHeaderData()
        +loadFooterData()
        +applyContainerState()
    }
    
    class ChatLogicClass {
        +channel
        +initMessageListener()
        +initChannel()
        +initSync()
        +sendTextMessage()
    }
    
    class ChatPageClass {
        +logic
        +build()
    }
    
    GetxController <|-- ChatMsgController
    ChatMsgController <|-- ChatLogicClass
    ChatLogicClass --o ChatPageClass
    
    class ChatSendUtils {
        +sendTextMessage()
        +sendImageMessage()
        +sendVideoMessage()
    }
    
    class ChatScrollController {
        +scrollToBottom()
        +scrollToIndex()
    }
    
    class ChatUnreadManager {
        +update()
        +clearUnread()
    }
    
    class ConversationMessageManager {
        +initializeConversation()
        +loadMore()
        +addNewMessage()
    }
    
    ChatLogicClass --> ChatSendUtils
    ChatLogicClass --> ChatScrollController
    ChatLogicClass --> ChatUnreadManager
    ChatLogicClass --> ConversationMessageManager
                </div>
            </div>
        </section>
    </div>
    
    <script>
        // ç­‰å¾… mermaid åº“åŠ è½½å®Œæˆ
        function waitForMermaid(callback, maxRetries = 50) {
            if (typeof mermaid !== 'undefined') {
                callback();
            } else if (maxRetries > 0) {
                setTimeout(() => waitForMermaid(callback, maxRetries - 1), 100);
            } else {
                console.error('Mermaid library failed to load');
            }
        }
        
        function initMermaid() {
            mermaid.initialize({
                startOnLoad: false,
                theme: 'dark',
                securityLevel: 'loose',
                fontFamily: '"Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                themeVariables: {
                    fontFamily: '"Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
                    fontSize: '14px',
                    primaryColor: '#3a2a5c',
                    primaryTextColor: '#e6edf3',
                    primaryBorderColor: '#a371f7',
                    lineColor: '#58a6ff',
                    secondaryColor: '#1a4a3a',
                    tertiaryColor: '#1a3a5c',
                    background: '#161b22',
                    mainBkg: '#21262d',
                    nodeBorder: '#30363d',
                    clusterBkg: '#21262d',
                    clusterBorder: '#30363d',
                    titleColor: '#e6edf3',
                    edgeLabelBackground: '#161b22',
                    nodeTextColor: '#e6edf3'
                },
                flowchart: {
                    useMaxWidth: false,
                    htmlLabels: true,
                    curve: 'basis',
                    nodeSpacing: 50,
                    rankSpacing: 80,
                    padding: 20
                },
                sequence: {
                    useMaxWidth: true,
                    actorMargin: 50,
                    messageMargin: 40
                }
            });
            
            // åˆå§‹åŒ–å®Œæˆåæ˜¾ç¤ºé»˜è®¤ section
            const valid = new Set(['overview','startup','upgrade','conversation','chat','message','contact','mine','connection','files']);
            const hash = location.hash ? location.hash.replace('#','') : '';
            const saved = localStorage.getItem('docActiveSection') || '';
            const initial = valid.has(hash) ? hash : (valid.has(saved) ? saved : 'overview');
            showSection(null, initial);
        }
        
        // ç¼©æ”¾çŠ¶æ€å­˜å‚¨
        const zoomLevels = {};
        
        function zoomChart(chartId, delta) {
            const chart = document.getElementById(chartId);
            if (!chart) return;
            
            if (!zoomLevels[chartId]) zoomLevels[chartId] = 1;
            
            zoomLevels[chartId] = Math.max(0.5, Math.min(2, zoomLevels[chartId] + delta));
            chart.style.transform = `scale(${zoomLevels[chartId]})`;
            
            const levelEl = document.getElementById(chartId + '-level');
            if (levelEl) {
                levelEl.textContent = Math.round(zoomLevels[chartId] * 100) + '%';
            }
        }
        
        function resetZoom(chartId) {
            const chart = document.getElementById(chartId);
            if (!chart) return;
            
            zoomLevels[chartId] = 1;
            chart.style.transform = 'scale(1)';
            
            const levelEl = document.getElementById(chartId + '-level');
            if (levelEl) {
                levelEl.textContent = '100%';
            }
        }
        
        function renderMermaidIn(sectionId) {
            if (typeof mermaid === 'undefined') return;
            const section = document.getElementById(sectionId);
            if (!section) return;
            const nodes = Array.from(section.querySelectorAll('.mermaid, .mermaid-large')).filter(el => el.getAttribute('data-processed') !== 'true');
            if (nodes.length === 0) return;
            try {
                mermaid.run({ nodes });
            } catch (e) {
                mermaid.init(undefined, nodes);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            waitForMermaid(initMermaid);
        });
        
        function showSection(evt, sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            
            const tabEl = (evt && evt.target) || document.querySelector(`.nav-tab[data-section="${sectionId}"]`);
            if (tabEl) tabEl.classList.add('active');
            
            renderMermaidIn(sectionId);
            try {
                if (sectionId) {
                    localStorage.setItem('docActiveSection', sectionId);
                    if (!evt) {
                        history.replaceState(null, '', '#' + sectionId);
                    } else {
                        location.hash = '#' + sectionId;
                    }
                }
            } catch (_) {}
        }
    </script>
</body>
</html>
